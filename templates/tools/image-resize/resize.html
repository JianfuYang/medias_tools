{% extends "common/base.html" %}

{% block title %}图片调整大小 - 媒体效率工具库{% endblock %}

{% block head %}
{{ super() }}
<style>
.image-preview {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
}

.dimension-input {
    width: 100px;
}

.aspect-ratio-lock {
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.aspect-ratio-lock:hover {
    background-color: #f3f4f6;
}

.drag-area {
    border: 2px dashed #e5e7eb;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.drag-area.dragover {
    border-color: #3b82f6;
    background-color: #f8fafc;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- 标题区域 -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">图片调整大小</h1>
        <p class="mt-2 text-gray-600">在浏览器中快速调整图片尺寸，无需上传服务器</p>
    </div>

    <!-- 上传区域 -->
    <div class="mb-8">
        <div id="drag-area" class="drag-area flex justify-center px-6 pt-5 pb-6 rounded-lg">
            <div class="space-y-1 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="text-sm text-gray-600">
                    <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                        <span>选择图片</span>
                        <input id="file-upload" type="file" class="sr-only" accept="image/*">
                    </label>
                    <span class="pl-1">或拖放图片到此处</span>
                </div>
                <p class="text-xs text-gray-500">支持 PNG、JPG、GIF 等格式</p>
            </div>
        </div>
    </div>

    <!-- 调整选项 -->
    <div class="mb-8 bg-white p-6 rounded-lg shadow-sm">
        <div class="grid grid-cols-2 gap-6">
            <!-- 宽度输入 -->
            <div>
                <label class="block text-sm font-medium text-gray-700">宽度</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="number" id="width" class="dimension-input focus:ring-blue-500 focus:border-blue-500 flex-1 block w-full rounded-md sm:text-sm border-gray-300" placeholder="宽度">
                    <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                        px
                    </span>
                </div>
            </div>

            <!-- 高度输入 -->
            <div>
                <label class="block text-sm font-medium text-gray-700">高度</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="number" id="height" class="dimension-input focus:ring-blue-500 focus:border-blue-500 flex-1 block w-full rounded-md sm:text-sm border-gray-300" placeholder="高度">
                    <span class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                        px
                    </span>
                </div>
            </div>
        </div>

        <!-- 锁定比例 -->
        <div class="mt-4 flex items-center justify-between">
            <button class="aspect-ratio-lock flex items-center text-gray-700">
                <svg id="lock-icon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span class="ml-2 text-sm">锁定宽高比</span>
            </button>

            <!-- 下载按钮 -->
            <button onclick="downloadImage()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled id="download-btn">
                下载图片
            </button>
        </div>
    </div>

    <!-- 预览区域 -->
    <div id="preview-container" class="mb-8 bg-white p-6 rounded-lg shadow-sm hidden">
        <h3 class="text-lg font-medium text-gray-900 mb-4">预览</h3>
        <div class="aspect-w-16 aspect-h-9 bg-gray-100 rounded-lg overflow-hidden">
            <img id="preview-image" class="image-preview object-contain" alt="预览图">
        </div>
        <div class="mt-4 text-center text-sm text-gray-500">
            调整后尺寸: <span id="resized-dimensions">0 × 0</span>
        </div>
    </div>
</div>

<!-- 隐藏的Canvas用于图片处理 -->
<canvas id="resize-canvas" style="display: none;"></canvas>
{% endblock %}

{% block scripts %}
<script>
let originalImage = null;
let aspectRatioLocked = true;
let originalWidth = 0;
let originalHeight = 0;

// 拖放处理
const dragArea = document.getElementById('drag-area');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dragArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dragArea.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dragArea.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    dragArea.classList.add('dragover');
}

function unhighlight(e) {
    dragArea.classList.remove('dragover');
}

dragArea.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const file = dt.files[0];
    handleFile(file);
}

// 文件上传处理
document.getElementById('file-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) handleFile(file);
});

function handleFile(file) {
    if (!file) return;
    
    // 检查文件类型
    if (!file.type.startsWith('image/')) {
        alert('请上传图片文件');
        return;
    }
    
    // 读取并预览图片
    const reader = new FileReader();
    reader.onload = function(e) {
        originalImage = new Image();
        originalImage.onload = function() {
            originalWidth = this.width;
            originalHeight = this.height;
            
            // 设置初始尺寸
            document.getElementById('width').value = originalWidth;
            document.getElementById('height').value = originalHeight;
            
            // 显示预览
            document.getElementById('preview-image').src = e.target.result;
            document.getElementById('preview-container').classList.remove('hidden');
            document.getElementById('download-btn').disabled = false;
            
            updatePreview();
        };
        originalImage.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// 尺寸输入处理
document.getElementById('width').addEventListener('input', function(e) {
    if (aspectRatioLocked && originalWidth > 0) {
        const ratio = originalHeight / originalWidth;
        document.getElementById('height').value = Math.round(e.target.value * ratio);
    }
    updatePreview();
});

document.getElementById('height').addEventListener('input', function(e) {
    if (aspectRatioLocked && originalHeight > 0) {
        const ratio = originalWidth / originalHeight;
        document.getElementById('width').value = Math.round(e.target.value * ratio);
    }
    updatePreview();
});

// 锁定比例切换
document.querySelector('.aspect-ratio-lock').addEventListener('click', function() {
    aspectRatioLocked = !aspectRatioLocked;
    const icon = document.getElementById('lock-icon');
    if (aspectRatioLocked) {
        icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />`;
    } else {
        icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />`;
    }
});

// 更新预览
function updatePreview() {
    const width = parseInt(document.getElementById('width').value);
    const height = parseInt(document.getElementById('height').value);
    document.getElementById('resized-dimensions').textContent = `${width} × ${height}`;
}

// 下载调整后的图片
function downloadImage() {
    if (!originalImage) return;
    
    const canvas = document.getElementById('resize-canvas');
    const width = parseInt(document.getElementById('width').value);
    const height = parseInt(document.getElementById('height').value);
    
    canvas.width = width;
    canvas.height = height;
    
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(originalImage, 0, 0, width, height);
    
    // 创建下载链接
    const link = document.createElement('a');
    link.download = 'resized-image.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
}
</script>
{% endblock %} 