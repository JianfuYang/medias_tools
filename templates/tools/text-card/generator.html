{% extends "common/base.html" %}

{% block title %}æ–‡å­—å¡ç‰‡ç”Ÿæˆå™¨ - åª’ä½“æ•ˆç‡å·¥å…·åº“{% endblock %}

{% block head %}
{{ super() }}
<!-- å¼•å…¥ Marked.js ç”¨äºMarkdownè§£æ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- å¼•å…¥ html2canvas ç”¨äºç”Ÿæˆå›¾ç‰‡ -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!-- å¼•å…¥ FileSaver.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<!-- å¼•å…¥æ€æºé»‘ä½“ -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
<!-- å¼•å…¥è‹¹æœé£æ ¼å­—ä½“ -->
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap" rel="stylesheet">
<!-- å¼•å…¥ GitHub Markdown æ ·å¼ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">

<style>
/* å…¨å±€æ ·å¼ */
:root {
    --primary-color: #0071e3;
    --hover-color: #0077ed;
    --bg-color: #ffffff;
    --text-color: #2C3E50;  /* é»˜è®¤æ–‡å­—é¢œè‰² */
    --secondary-text: #86868b;
    --border-color: #d2d2d7;
}

body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
}

.card-preview {
    min-height: 200px;
    max-width: 800px;
    margin: 0 auto;
    position: relative;
    background: var(--bg-color);
    border-radius: 14px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: all 0.3s ease;
    padding: 1.5rem;
    font-family: 'Noto Sans SC', sans-serif;
    display: flex;
    flex-direction: column;
}

.card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: var(--text-color);
    position: relative;
    z-index: 1;
}

.control-panel {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 14px;
    border: 1px solid var(--border-color);
    padding: 1.5rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-color);
}

.input-group {
    margin-bottom: 1.5rem;
}

.input-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--secondary-text);
    margin-bottom: 0.5rem;
}

.template-option {
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.template-option:hover {
    transform: translateY(-2px);
}

.template-option.selected {
    border-color: #3b82f6;
}

.gradient-option {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.gradient-option:hover {
    transform: scale(1.1);
}

.gradient-option.selected {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

/* åº•åº§é¢œè‰²æ ·å¼ */
.base-color {
    position: absolute;
    inset: 0;
    border-radius: 14px;
    z-index: 0;
}

.base-color-1 { background: linear-gradient(45deg, #12c2e9, #c471ed, #f64f59); }
.base-color-2 { background: linear-gradient(45deg, #FF9A9E, #FAD0C4); }
.base-color-3 { background: linear-gradient(45deg, #a8edea, #fed6e3); }
.base-color-4 { background: linear-gradient(45deg, #d4fc79, #96e6a1); }
.base-color-5 { background: linear-gradient(45deg, #84fab0, #8fd3f4); }
.base-color-6 { background: linear-gradient(45deg, #a6c0fe, #f68084); }
.base-color-7 { background: linear-gradient(45deg, #fbc2eb, #a6c1ee); }
.base-color-8 { background: linear-gradient(45deg, #f6d365, #fda085); }
.base-color-9 { background: linear-gradient(45deg, #ffd1ff, #fad0c4); }

/* é¢„è®¾æ¨¡æ¿æ ·å¼ */
.content-wrapper {
    position: relative;
    margin: 12px;
    border-radius: 10px;
    background: var(--bg-color);
    color: var(--text-color);
    z-index: 1;
    height: calc(100% - 24px);
    padding: 1.5rem;
}

/* æ¸å˜åº•åº§æ ·å¼ */
.gradient-none {
    display: none;
}

.gradient-simple {
    height: 4px;
    background: linear-gradient(to right, #3b82f6, #60a5fa);
}

.gradient-elegant {
    height: 6px;
    background: linear-gradient(45deg, #f6d365, #fda085);
}

.gradient-modern {
    height: 8px;
    background: linear-gradient(to right, #4f46e5, #818cf8);
}

.gradient-1 {
    background: linear-gradient(45deg, #12c2e9, #c471ed, #f64f59);
    height: 4px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
}

.gradient-2 {
    background: linear-gradient(45deg, #FF9A9E, #FAD0C4);
    height: 4px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
}

.gradient-3 {
    background: linear-gradient(45deg, #a8edea, #fed6e3);
}

.gradient-4 {
    background: linear-gradient(45deg, #d4fc79, #96e6a1);
}

.gradient-5 {
    background: linear-gradient(45deg, #84fab0, #8fd3f4);
}

.gradient-6 {
    background: linear-gradient(45deg, #a6c0fe, #f68084);
}

.gradient-7 {
    background: linear-gradient(45deg, #fbc2eb, #a6c1ee);
}

.gradient-8 {
    background: linear-gradient(45deg, #f6d365, #fda085);
}

.gradient-9 {
    background: linear-gradient(45deg, #ffd1ff, #fad0c4);
}

/* é¢„è®¾æ¨¡æ¿/èƒŒæ™¯é¢œè‰² */
.bg-template {
    padding: 1.5rem;
    height: 100%;
    width: 100%;
}

/* è°ƒæ•´é¢„è§ˆåŒºåŸŸåœ¨ç§»åŠ¨ç«¯çš„ä½ç½® */
@media (max-width: 1024px) {
    .card-preview {
        min-height: 250px;
    }
}

/* Markdown æ ·å¼å®šåˆ¶ */
.markdown-body {
    font-family: inherit;
    font-size: inherit;
    line-height: 1.6;
    color: var(--text-color);
    background-color: transparent;
}

.markdown-body h1 {
    font-size: 1.75em;
    border-bottom: none;
    padding-bottom: 0.3em;
    margin-bottom: 0.75em;
}

.markdown-body h2 {
    font-size: 1.5em;
    border-bottom: none;
    padding-bottom: 0.3em;
    margin-bottom: 0.75em;
}

.markdown-body blockquote {
    border-left: 4px solid currentColor;
    opacity: 0.8;
    margin: 1em 0;
    padding: 0 1em;
}

.markdown-body ul,
.markdown-body ol {
    padding-left: 1.5em;
    margin: 0.5em 0;
}

.markdown-body code {
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
    padding: 0.2em 0.4em;
}

.markdown-body pre {
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 6px;
    padding: 1em;
    margin: 1em 0;
}

/* æ·»åŠ é¢„è§ˆåŒºåŸŸå®¹å™¨æ ·å¼ */
.preview-container {
    width: 100%;
    padding: 2rem;
    background-color: #f8f9fa;
    border-radius: 1rem;
    margin-top: 2rem;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-12">
    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-semibold mb-4">æ–‡å­—å¡ç‰‡ç”Ÿæˆå™¨</h1>
        <p class="text-lg text-secondary-text max-w-2xl mx-auto">
            åˆ›å»ºä¼˜é›…ç¾è§‚çš„æ–‡å­—å¡ç‰‡ï¼Œæ”¯æŒMarkdownæ ¼å¼ï¼Œé€‚åˆç¤¾äº¤åª’ä½“åˆ†äº«æˆ–ä¸ªäººä½¿ç”¨ã€‚æœ€ä½³æ–‡å­—å›¾å·¥å…· <a href="https://midjourney.com" class="text-blue-600 hover:underline" target="_blank">Midjourney</a>
        </p>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸï¼šä¸Šä¸‹å¸ƒå±€ -->
    <div class="space-y-8">
        <!-- ä¸Šéƒ¨åˆ†ï¼šè¾“å…¥å’Œå‚æ•°è®¾ç½®åŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- å·¦ä¾§ï¼šæ–‡æœ¬è¾“å…¥åŒºåŸŸ -->
            <div class="control-panel h-full">
                <h2 class="section-title">è¾“å…¥æ–‡å­—</h2>
                <div class="mb-4 flex space-x-4">
                    <button id="example-1" class="text-sm text-primary-color hover:text-hover-color">
                        ç¤ºä¾‹1
                    </button>
                    <button id="example-2" class="text-sm text-primary-color hover:text-hover-color">
                        ç¤ºä¾‹2
                    </button>
                    <button id="example-3" class="text-sm text-primary-color hover:text-hover-color">
                        ç¤ºä¾‹3
                    </button>
                </div>
                <textarea id="text-input" 
                    class="w-full h-[calc(100%-80px)] p-4 border border-border-color rounded-lg resize-none focus:ring-2 focus:ring-primary-color focus:border-transparent"
                    placeholder="åœ¨æ­¤è¾“å…¥æ–‡å­—å†…å®¹ï¼Œæ”¯æŒMarkdownæ ¼å¼ï¼ˆå¦‚ï¼š# æ ‡é¢˜ã€**ç²—ä½“**ã€> å¼•ç”¨ç­‰ï¼‰..."></textarea>
            </div>

            <!-- å³ä¾§ï¼šå‚æ•°è®¾ç½®åŒºåŸŸ -->
            <div class="control-panel h-full">
                <h2 class="section-title">æ ·å¼è®¾ç½®</h2>
                <div class="grid grid-cols-1 gap-4 h-[calc(100%-48px)] overflow-y-auto">
                    <!-- èƒŒæ™¯é¢œè‰²/æ¨¡æ¿é€‰æ‹© -->
                    <div>
                        <h3 class="input-label">é€‰æ‹©æ¨¡æ¿</h3>
                        <div class="grid grid-cols-4 gap-2">
                            <!-- æ¸…æ–°ç®€çº¦ -->
                            <div class="template-option selected" data-template="clean" 
                                data-bg-color="#FFFFFF" data-text-color="#2C3E50" data-name="æ¸…æ–°ç®€çº¦" data-custom="true">
                                <div class="h-16 bg-white rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">æ¸…æ–°ç®€çº¦</p>
                            </div>
                            
                            <!-- ä¼˜é›…ç±³è‰² -->
                            <div class="template-option" data-template="elegant"
                                data-bg-color="#F8F4F0" data-text-color="#2C3E50" data-name="ä¼˜é›…ç±³è‰²" data-custom="false">
                                <div class="h-16 bg-[#F8F4F0] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">ä¼˜é›…ç±³è‰²</p>
                            </div>
                            
                            <!-- æ·±é‚ƒå¤œç©º -->
                            <div class="template-option" data-template="dark"
                                data-bg-color="#1A1A1A" data-text-color="#FFFFFF" data-name="æ·±é‚ƒå¤œç©º" data-custom="false">
                                <div class="h-16 bg-[#1A1A1A] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">æ·±é‚ƒå¤œç©º</p>
                            </div>
                            
                            <!-- è–„è·æ¸…æ–° -->
                            <div class="template-option" data-template="mint"
                                data-bg-color="#E8F5E9" data-text-color="#2C3E50" data-name="è–„è·æ¸…æ–°" data-custom="false">
                                <div class="h-16 bg-[#E8F5E9] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">è–„è·æ¸…æ–°</p>
                            </div>
                            
                            <!-- å¤©ç©ºè“ -->
                            <div class="template-option" data-template="sky"
                                data-bg-color="#E3F2FD" data-text-color="#2C3E50" data-name="å¤©ç©ºè“" data-custom="false">
                                <div class="h-16 bg-[#E3F2FD] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">å¤©ç©ºè“</p>
                            </div>
                            
                            <!-- æš–é˜³æ©™ -->
                            <div class="template-option" data-template="sunset"
                                data-bg-color="#FFF3E0" data-text-color="#2C3E50" data-name="æš–é˜³æ©™" data-custom="false">
                                <div class="h-16 bg-[#FFF3E0] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">æš–é˜³æ©™</p>
                            </div>
                            
                            <!-- æµ…ç²‰çº¢ -->
                            <div class="template-option" data-template="pink"
                                data-bg-color="#FCE4EC" data-text-color="#2C3E50" data-name="æµ…ç²‰çº¢" data-custom="false">
                                <div class="h-16 bg-[#FCE4EC] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">æµ…ç²‰çº¢</p>
                            </div>
                            
                            <!-- æ·¡ç´«è‰² -->
                            <div class="template-option" data-template="lavender"
                                data-bg-color="#F3E5F5" data-text-color="#2C3E50" data-name="æ·¡ç´«è‰²" data-custom="false">
                                <div class="h-16 bg-[#F3E5F5] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">æ·¡ç´«è‰²</p>
                            </div>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰èƒŒæ™¯é¢œè‰² -->
                    <div class="mt-4">
                        <label class="input-label">è‡ªå®šä¹‰èƒŒæ™¯é¢œè‰²</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="bg-color" value="#FFFFFF" class="w-full h-10 rounded-lg cursor-pointer">
                            <div class="bg-white px-3 py-2 rounded-lg border border-gray-200 min-w-[90px] text-sm text-gray-600" id="color-value">
                                #FFFFFF
                            </div>
                        </div>
                    </div>

                    <!-- åº•åº§é¢œè‰² -->
                    <div>
                        <h3 class="input-label">åº•åº§é¢œè‰²</h3>
                        <div class="flex flex-wrap gap-2">
                            <div class="gradient-option selected" data-gradient="none" style="background: #e5e7eb;">
                                <span class="text-red-500 text-2xl flex items-center justify-center h-full">ğŸš«</span>
                            </div>
                            <div class="gradient-option base-color-1" data-gradient="base-color-1"></div>
                            <div class="gradient-option base-color-2" data-gradient="base-color-2"></div>
                            <div class="gradient-option base-color-3" data-gradient="base-color-3"></div>
                            <div class="gradient-option base-color-4" data-gradient="base-color-4"></div>
                            <div class="gradient-option base-color-5" data-gradient="base-color-5"></div>
                            <div class="gradient-option base-color-6" data-gradient="base-color-6"></div>
                            <div class="gradient-option base-color-7" data-gradient="base-color-7"></div>
                            <div class="gradient-option base-color-8" data-gradient="base-color-8"></div>
                            <div class="gradient-option base-color-9" data-gradient="base-color-9"></div>
                        </div>
                    </div>

                    <!-- å­—ä½“è®¾ç½® -->
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="input-label">å­—ä½“</label>
                            <select id="font-family" class="w-full border border-gray-300 rounded-lg p-2">
                                <option value="Noto Sans SC">æ€æºé»‘ä½“</option>
                                <option value="å¾®è½¯é›…é»‘">å¾®è½¯é›…é»‘</option>
                                <option value="å®‹ä½“">å®‹ä½“</option>
                                <option value="æ¥·ä½“">æ¥·ä½“</option>
                                <option value="é»‘ä½“">é»‘ä½“</option>
                            </select>
                        </div>
                        <div>
                            <label class="input-label">å­—ä½“å¤§å°</label>
                            <input type="number" id="font-size" value="16" min="12" max="72" 
                                class="w-full border border-gray-300 rounded-lg p-2">
                        </div>
                    </div>

                    <!-- å…¶ä»–è®¾ç½® -->
                    <div>
                        <label class="input-label">å›¾ç‰‡æ¯”ä¾‹</label>
                        <select id="aspect-ratio" class="w-full border border-gray-300 rounded-lg p-2">
                            <option value="auto">è‡ªç”±æ¯”ä¾‹</option>
                            <option value="1:1">1:1 æ­£æ–¹å½¢</option>
                            <option value="4:3">4:3 æ¨ªç‰ˆ</option>
                            <option value="16:9">16:9 å®½å±</option>
                            <option value="3:4">3:4 ç«–ç‰ˆ</option>
                            <option value="9:16">9:16 æ‰‹æœºå±</option>
                        </select>
                    </div>

                    <div>
                        <label class="input-label">è‡ªåŠ¨åˆ†å‰²é•¿æ–‡æœ¬</label>
                        <div class="flex items-center">
                            <input type="checkbox" id="auto-split" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-600">è‡ªåŠ¨å°†é•¿æ–‡æœ¬åˆ†å‰²æˆå¤šå¼ å¡ç‰‡</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸‹éƒ¨åˆ†ï¼šé¢„è§ˆå’Œå¯¼å‡ºåŒºåŸŸ -->
        <div class="space-y-6">
            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div class="control-panel">
                <h2 class="section-title text-center">é¢„è§ˆ</h2>
                <div class="preview-container">
                    <div id="card-preview" class="card-preview"></div>
                </div>
            </div>

            <!-- å¯¼å‡ºæŒ‰é’® -->
            <div class="flex justify-center space-x-4 mt-8">
                <button id="download-png" class="px-6 py-2.5 bg-primary-color text-white rounded-full hover:bg-hover-color transition-colors">
                    <span class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        å¯¼å‡ºä¸ºPNG
                    </span>
                </button>
                <button id="download-jpg" class="px-6 py-2.5 bg-primary-color text-white rounded-full hover:bg-hover-color transition-colors">
                    <span class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        å¯¼å‡ºä¸ºJPG
                    </span>
                </button>
            </div>

            <!-- å¯¼å‡ºæç¤º -->
            <div class="text-center mt-4 text-sm text-secondary-text">
                <p>æç¤ºï¼šå¯¼å‡ºçš„å›¾ç‰‡å°†ä¿æŒåŸå§‹æ¯”ä¾‹å’Œè´¨é‡</p>
            </div>
        </div>
    </div>
</div>

<script>
// åˆå§‹åŒ–é¢„è§ˆ
function initPreview() {
    const preview = document.getElementById('card-preview');
    preview.style.minHeight = window.innerWidth > 1024 ? '400px' : '250px';
    updatePreview();
}

// å·¥å…·å‡½æ•°ï¼šè®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
function setButtonLoading(button, isLoading) {
    if (!button) return;
    button.disabled = isLoading;
    const span = button.querySelector('span');
    if (isLoading) {
        span.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>`;
    } else {
        span.innerHTML = button.dataset.originalContent;
    }
}

// å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(message, type = 'error') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
        type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// å¯¼å‡ºä¸ºå›¾ç‰‡
async function exportToImage(format) {
    const button = document.getElementById(`download-${format}`);
    if (!button.dataset.originalContent) {
        button.dataset.originalContent = button.querySelector('span').innerHTML;
    }
    
    setButtonLoading(button, true);
    
    try {
        const preview = document.getElementById('card-preview');
        const ratio = document.getElementById('aspect-ratio').value;
        
        // ä¿å­˜åŸå§‹æ ·å¼
        const originalStyle = {
            width: preview.style.width,
            height: preview.style.height,
            aspectRatio: preview.style.aspectRatio
        };
        
        // è®¾ç½®é¢„è§ˆåŒºåŸŸçš„æ¯”ä¾‹
        if (ratio !== 'auto') {
            const [width, height] = ratio.split(':').map(Number);
            const baseSize = 1200; // åŸºç¡€å°ºå¯¸
            if (width > height) {
                preview.style.width = `${baseSize}px`;
                preview.style.height = `${(baseSize * height) / width}px`;
            } else {
                preview.style.height = `${baseSize}px`;
                preview.style.width = `${(baseSize * width) / height}px`;
            }
            preview.style.aspectRatio = `${width}/${height}`;
        }
        
        // åˆ›å»ºcanvas
        const canvas = await html2canvas(preview, {
            scale: 2, // æé«˜æ¸…æ™°åº¦
            useCORS: true,
            backgroundColor: format === 'jpg' ? '#FFFFFF' : null,
            logging: false,
            allowTaint: true,
            foreignObjectRendering: true,
            onclone: function(clonedDoc) {
                const clonedPreview = clonedDoc.getElementById('card-preview');
                clonedPreview.style.transform = 'none';
                clonedPreview.style.boxShadow = 'none';
            }
        });
        
        // è½¬æ¢ä¸ºblob
        canvas.toBlob((blob) => {
            if (!blob) {
                showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                return;
            }
            
            // ä¸‹è½½æ–‡ä»¶
            const timestamp = new Date().getTime();
            const filename = `text-card-${timestamp}.${format}`;
            saveAs(blob, filename);
            showToast('å¯¼å‡ºæˆåŠŸï¼', 'success');
        }, `image/${format}`, format === 'jpg' ? 0.92 : 1);
        
    } catch (error) {
        console.error('Export error:', error);
        showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
    } finally {
        setButtonLoading(button, false);
        // æ¢å¤é¢„è§ˆåŒºåŸŸçš„åŸå§‹æ ·å¼
        Object.assign(preview.style, originalStyle);
    }
}

// è‡ªåŠ¨åˆ†å‰²é•¿æ–‡æœ¬
function splitLongText(text) {
    if (!document.getElementById('auto-split').checked) return [text];
    
    const maxLength = 500; // æ¯å¼ å¡ç‰‡çš„æœ€å¤§å­—ç¬¦æ•°
    const paragraphs = text.split('\n\n');
    const cards = [];
    let currentCard = '';
    
    for (const paragraph of paragraphs) {
        if (currentCard.length + paragraph.length > maxLength) {
            if (currentCard) cards.push(currentCard.trim());
            currentCard = paragraph;
        } else {
            currentCard += (currentCard ? '\n\n' : '') + paragraph;
        }
    }
    
    if (currentCard) cards.push(currentCard.trim());
    return cards;
}

// ç¤ºä¾‹æ–‡æœ¬
const examples = {
    example1: `# å¿ƒçµé¸¡æ±¤

> ç”Ÿæ´»ä¸æ˜¯ç­‰å¾…æš´é£é›¨è¿‡å»ï¼Œè€Œæ˜¯å­¦ä¼šåœ¨é›¨ä¸­ç¿©ç¿©èµ·èˆã€‚

**æ¯ä¸€ä¸ªä¸æ›¾èµ·èˆçš„æ—¥å­ï¼Œéƒ½æ˜¯å¯¹ç”Ÿå‘½çš„è¾œè´Ÿã€‚**`,

    example2: `# å·¥ä½œç¬”è®°

## ä»Šæ—¥ä»»åŠ¡

- [x] å®Œæˆé¡¹ç›®æ–¹æ¡ˆ
- [x] å›¢é˜Ÿä¼šè®®
- [ ] ä»£ç å®¡æŸ¥

*deadline: 2024-03-20*`,

    example3: `# ç¾é£Ÿé£Ÿè°±

## çº¢çƒ§è‚‰

1. å‡†å¤‡é£Ÿæ
2. ç…¸ç‚’ç³–è‰²
3. åŠ å…¥è°ƒæ–™

*Tips: å°ç«æ…¢ç‚–æ›´å…¥å‘³*`
};

// åŠ è½½ç¤ºä¾‹æ–‡æœ¬
function loadExample(id) {
    const textarea = document.getElementById('text-input');
    textarea.value = examples[`example${id}`];
    updatePreview();
}

// æ›´æ–°é¢„è§ˆ
function updatePreview() {
    const preview = document.getElementById('card-preview');
    const selectedTemplate = document.querySelector('.template-option.selected');
    const isCustomTemplate = selectedTemplate.dataset.custom === 'true';
    const bgColorInput = document.getElementById('bg-color');
    
    // é‡ç½®é¢„è§ˆåŒºåŸŸ
    preview.innerHTML = '';
    preview.className = 'card-preview';
    
    // è®¾ç½®èƒŒæ™¯é¢œè‰²å’Œæ–‡å­—é¢œè‰²
    if (isCustomTemplate) {
        preview.style.setProperty('--bg-color', bgColorInput.value);
    } else {
        preview.style.setProperty('--bg-color', selectedTemplate.dataset.bgColor);
        bgColorInput.value = selectedTemplate.dataset.bgColor;
    }
    
    // è®¾ç½®æ–‡å­—é¢œè‰²ï¼ˆå¯¹æ‰€æœ‰æ¨¡æ¿éƒ½ç”Ÿæ•ˆï¼‰
    document.documentElement.style.setProperty('--text-color', selectedTemplate.dataset.textColor);
    
    // æ·»åŠ åº•åº§é¢œè‰²
    const baseColor = document.querySelector('.gradient-option.selected').dataset.gradient;
    if (baseColor !== 'none') {
        const baseColorElement = document.createElement('div');
        baseColorElement.className = `base-color ${baseColor}`;
        preview.appendChild(baseColorElement);
    }
    
    // åˆ›å»ºå†…å®¹åŒ…è£…å™¨
    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'content-wrapper';
    
    // åˆ›å»ºå†…å®¹å®¹å™¨
    const contentContainer = document.createElement('div');
    contentContainer.className = 'bg-template';
    
    const text = document.getElementById('text-input').value;
    const cards = splitLongText(text);

    cards.forEach((cardText, index) => {
        if (index > 0) {
            const pageDivider = document.createElement('div');
            pageDivider.className = 'border-t border-gray-200 my-4';
            contentContainer.appendChild(pageDivider);
        }

        const cardElement = document.createElement('div');
        cardElement.className = 'card-content markdown-body';
        cardElement.innerHTML = marked.parse(cardText);
        contentContainer.appendChild(cardElement);
    });

    // å°†å†…å®¹å®¹å™¨æ·»åŠ åˆ°åŒ…è£…å™¨
    contentWrapper.appendChild(contentContainer);

    const fontFamily = document.getElementById('font-family').value;
    const fontSize = document.getElementById('font-size').value;
    
    // åº”ç”¨æ ·å¼
    const customStyles = {
        fontFamily: fontFamily,
        fontSize: `${fontSize}px`,
        backgroundColor: preview.style.getPropertyValue('--bg-color'),
        color: preview.style.getPropertyValue('--text-color')
    };
    
    Object.entries(customStyles).forEach(([key, value]) => {
        if (value) {
            contentWrapper.style[key] = value;
        }
    });

    // åº”ç”¨æ¯”ä¾‹è®¾ç½®
    const ratio = document.getElementById('aspect-ratio').value;
    if (ratio !== 'auto') {
        const [width, height] = ratio.split(':').map(Number);
        preview.style.aspectRatio = `${width}/${height}`;
    }

    // å°†åŒ…è£…å™¨æ·»åŠ åˆ°é¢„è§ˆåŒºåŸŸ
    preview.appendChild(contentWrapper);
}

// æ¨¡æ¿é€‰æ‹©äº‹ä»¶å¤„ç†
document.querySelectorAll('.template-option').forEach(option => {
    option.addEventListener('click', function() {
        // ç§»é™¤å…¶ä»–æ¨¡æ¿çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.template-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // æ·»åŠ å½“å‰æ¨¡æ¿çš„é€‰ä¸­çŠ¶æ€
        this.classList.add('selected');
        
        // è·å–æ¨¡æ¿æ•°æ®
        const bgColor = this.dataset.bgColor;
        const textColor = this.dataset.textColor;
        const isCustom = this.dataset.custom === 'true';
        
        // æ›´æ–°èƒŒæ™¯è‰²è¾“å…¥æ¡†å’Œé¢„è§ˆ
        const bgColorInput = document.getElementById('bg-color');
        bgColorInput.value = bgColor;
        bgColorInput.disabled = !isCustom;
        
        // æ›´æ–°é¢œè‰²å€¼æ˜¾ç¤º
        const colorValueDisplay = document.getElementById('color-value');
        colorValueDisplay.textContent = bgColor.toUpperCase();
        
        // æ›´æ–°CSSå˜é‡
        const preview = document.getElementById('card-preview');
        preview.style.setProperty('--bg-color', bgColor);
        document.documentElement.style.setProperty('--text-color', textColor);
        
        updatePreview();
    });
});

// ç›‘å¬æ¸å˜é€‰æ‹©
document.querySelectorAll('.gradient-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.gradient-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        this.classList.add('selected');
        updatePreview();
    });
});

// ç›‘å¬å…¶ä»–è®¾ç½®å˜åŒ–
// å­—ä½“é€‰æ‹©å®æ—¶æ›´æ–°
document.getElementById('font-family').addEventListener('change', updatePreview);

// å­—ä½“å¤§å°å®æ—¶æ›´æ–°
const fontSizeInput = document.getElementById('font-size');
fontSizeInput.addEventListener('input', updatePreview);
fontSizeInput.addEventListener('change', updatePreview);

// èƒŒæ™¯é¢œè‰²å˜åŒ–æ—¶çš„å¤„ç†
const bgColorInput = document.getElementById('bg-color');
const colorValueDisplay = document.getElementById('color-value');

bgColorInput.addEventListener('input', function() {
    // å½“èƒŒæ™¯é¢œè‰²æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°è‡ªå®šä¹‰æ¨¡æ¿
    const customTemplate = document.querySelector('.template-option[data-template="clean"]');
    if (!customTemplate.classList.contains('selected')) {
        document.querySelectorAll('.template-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        customTemplate.classList.add('selected');
    }
    
    // ç›´æ¥æ›´æ–°CSSå˜é‡
    const preview = document.getElementById('card-preview');
    preview.style.setProperty('--bg-color', this.value);
    document.documentElement.style.setProperty('--text-color', customTemplate.dataset.textColor);
    
    // æ›´æ–°é¢œè‰²å€¼æ˜¾ç¤º
    colorValueDisplay.textContent = this.value.toUpperCase();
    
    updatePreview();
});

// å›¾ç‰‡æ¯”ä¾‹å®æ—¶æ›´æ–°
document.getElementById('aspect-ratio').addEventListener('change', function() {
    const preview = document.getElementById('card-preview');
    const ratio = this.value;
    if (ratio === 'auto') {
        preview.style.aspectRatio = 'auto';
    } else {
        const [width, height] = ratio.split(':').map(Number);
        preview.style.aspectRatio = `${width}/${height}`;
    }
    updatePreview();
});

// ç›‘å¬è‡ªåŠ¨åˆ†å‰²å¼€å…³
document.getElementById('auto-split').addEventListener('change', updatePreview);

// ç»‘å®šå¯¼å‡ºæŒ‰é’®äº‹ä»¶
document.getElementById('download-png').addEventListener('click', () => exportToImage('png'));
document.getElementById('download-jpg').addEventListener('click', () => exportToImage('jpg'));

// ç»‘å®šç¤ºä¾‹æŒ‰é’®äº‹ä»¶
document.getElementById('example-1').addEventListener('click', () => loadExample(1));
document.getElementById('example-2').addEventListener('click', () => loadExample(2));
document.getElementById('example-3').addEventListener('click', () => loadExample(3));

// åˆå§‹åŒ–é¢„è§ˆ
updatePreview();

// åˆå§‹åŒ–æ—¶è®¾ç½®é¢œè‰²å€¼æ˜¾ç¤º
document.addEventListener('DOMContentLoaded', function() {
    colorValueDisplay.textContent = bgColorInput.value.toUpperCase();
});
</script>
{% endblock %} 