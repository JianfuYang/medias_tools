{% extends "common/base.html" %}

{% block title %}æ–‡å­—å¡ç‰‡ç”Ÿæˆå™¨ - åª’ä½“æ•ˆç‡å·¥å…·åº“{% endblock %}

{% block head %}
{{ super() }}
<!-- å¼•å…¥ Marked.js ç”¨äºMarkdownè§£æ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- å¼•å…¥ html2canvas ç”¨äºç”Ÿæˆå›¾ç‰‡ -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!-- å¼•å…¥ FileSaver.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<!-- å¼•å…¥æ€æºé»‘ä½“ -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
<!-- å¼•å…¥è‹¹æœé£æ ¼å­—ä½“ -->
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap" rel="stylesheet">
<!-- å¼•å…¥ GitHub Markdown æ ·å¼ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">

<style>
/* å…¨å±€æ ·å¼ */
:root {
    --primary-color: #0071e3;
    --hover-color: #0077ed;
    --bg-color: #ffffff;
    --text-color: #2C3E50;  /* é»˜è®¤æ–‡å­—é¢œè‰² */
    --secondary-text: #86868b;
    --border-color: #d2d2d7;
}

body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
}

.card-preview {
    min-height: 200px;
    max-width: 800px;
    margin: 0 auto;
    position: relative;
    background: var(--bg-color);
    border-radius: 14px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: all 0.3s ease;
    padding: 1.5rem;
    font-family: 'Noto Sans SC', sans-serif;
    display: flex;
    flex-direction: column;
}

.card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: var(--text-color);
    position: relative;
    z-index: 1;
}

.control-panel {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 14px;
    border: 1px solid var(--border-color);
    padding: 1.5rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-color);
}

.input-group {
    margin-bottom: 1.5rem;
}

.input-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--secondary-text);
    margin-bottom: 0.5rem;
}

.template-option {
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.template-option:hover {
    transform: translateY(-2px);
}

.template-option.selected {
    border-color: #3b82f6;
}

.gradient-option {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.gradient-option:hover {
    transform: scale(1.1);
}

.gradient-option.selected {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

/* åº•åº§é¢œè‰²æ ·å¼ */
.base-color {
    position: absolute;
    inset: 0;
    border-radius: 14px;
    z-index: 0;
}

.base-color-1 { background: linear-gradient(45deg, #12c2e9, #c471ed, #f64f59); }
.base-color-2 { background: linear-gradient(45deg, #FF9A9E, #FAD0C4); }
.base-color-3 { background: linear-gradient(45deg, #a8edea, #fed6e3); }
.base-color-4 { background: linear-gradient(45deg, #d4fc79, #96e6a1); }
.base-color-5 { background: linear-gradient(45deg, #84fab0, #8fd3f4); }
.base-color-6 { background: linear-gradient(45deg, #a6c0fe, #f68084); }
.base-color-7 { background: linear-gradient(45deg, #fbc2eb, #a6c1ee); }
.base-color-8 { background: linear-gradient(45deg, #f6d365, #fda085); }
.base-color-9 { background: linear-gradient(45deg, #ffd1ff, #fad0c4); }

/* é¢„è®¾æ¨¡æ¿æ ·å¼ */
.content-wrapper {
    position: relative;
    margin: 12px;
    border-radius: 10px;
    background: var(--bg-color);
    color: var(--text-color);
    z-index: 1;
    height: calc(100% - 24px);
    padding: 1.5rem;
}

/* æ¸å˜åº•åº§æ ·å¼ */
.gradient-none {
    display: none;
}

.gradient-simple {
    height: 4px;
    background: linear-gradient(to right, #3b82f6, #60a5fa);
}

.gradient-elegant {
    height: 6px;
    background: linear-gradient(45deg, #f6d365, #fda085);
}

.gradient-modern {
    height: 8px;
    background: linear-gradient(to right, #4f46e5, #818cf8);
}

.gradient-1 {
    background: linear-gradient(45deg, #12c2e9, #c471ed, #f64f59);
    height: 4px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
}

.gradient-2 {
    background: linear-gradient(45deg, #FF9A9E, #FAD0C4);
    height: 4px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
}

.gradient-3 {
    background: linear-gradient(45deg, #a8edea, #fed6e3);
}

.gradient-4 {
    background: linear-gradient(45deg, #d4fc79, #96e6a1);
}

.gradient-5 {
    background: linear-gradient(45deg, #84fab0, #8fd3f4);
}

.gradient-6 {
    background: linear-gradient(45deg, #a6c0fe, #f68084);
}

.gradient-7 {
    background: linear-gradient(45deg, #fbc2eb, #a6c1ee);
}

.gradient-8 {
    background: linear-gradient(45deg, #f6d365, #fda085);
}

.gradient-9 {
    background: linear-gradient(45deg, #ffd1ff, #fad0c4);
}

/* é¢„è®¾æ¨¡æ¿/èƒŒæ™¯é¢œè‰² */
.bg-template {
    padding: 1.5rem;
    height: 100%;
    width: 100%;
}

/* è°ƒæ•´é¢„è§ˆåŒºåŸŸåœ¨ç§»åŠ¨ç«¯çš„ä½ç½® */
@media (max-width: 1024px) {
    .card-preview {
        min-height: 250px;
    }
}

/* Markdown æ ·å¼å®šåˆ¶ */
.markdown-body {
    font-family: inherit;
    font-size: inherit;
    line-height: 1.6;
    color: var(--text-color);
    background-color: transparent;
}

.markdown-body h1 {
    font-size: 1.75em;
    border-bottom: none;
    padding-bottom: 0.3em;
    margin-bottom: 0.75em;
}

.markdown-body h2 {
    font-size: 1.5em;
    border-bottom: none;
    padding-bottom: 0.3em;
    margin-bottom: 0.75em;
}

.markdown-body blockquote {
    border-left: 4px solid currentColor;
    opacity: 0.8;
    margin: 1em 0;
    padding: 0 1em;
}

.markdown-body ul,
.markdown-body ol {
    padding-left: 1.5em;
    margin: 0.5em 0;
}

.markdown-body code {
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
    padding: 0.2em 0.4em;
}

.markdown-body pre {
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 6px;
    padding: 1em;
    margin: 1em 0;
}

/* æ·»åŠ é¢„è§ˆåŒºåŸŸå®¹å™¨æ ·å¼ */
.preview-container {
    width: 100%;
    padding: 2rem;
    background-color: #f8f9fa;
    border-radius: 1rem;
    margin-top: 2rem;
    overflow: auto;
    min-height: 300px;
}

/* é¢„åŠ è½½å­—ä½“ */
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=LXGW+WenKai:wght@400;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');

/* å®šä¹‰å­—ä½“å›é€€æ–¹æ¡ˆ */
.card-content {
    font-feature-settings: "liga" 0;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-12">
    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-semibold mb-4">æ–‡å­—å¡ç‰‡ç”Ÿæˆå™¨</h1>
        <p class="text-lg text-secondary-text max-w-2xl mx-auto">
            åˆ›å»ºä¼˜é›…ç¾è§‚çš„æ–‡å­—å¡ç‰‡ï¼Œæ”¯æŒMarkdownæ ¼å¼ï¼Œé€‚åˆç¤¾äº¤åª’ä½“åˆ†äº«æˆ–ä¸ªäººä½¿ç”¨ã€‚æœ€ä½³æ–‡å­—å›¾å·¥å…· <a href="https://midjourney.com" class="text-blue-600 hover:underline" target="_blank">Midjourney</a>
        </p>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸï¼šä¸Šä¸‹å¸ƒå±€ -->
    <div class="space-y-8">
        <!-- ä¸Šéƒ¨åˆ†ï¼šè¾“å…¥å’Œå‚æ•°è®¾ç½®åŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- å·¦ä¾§ï¼šæ–‡æœ¬è¾“å…¥åŒºåŸŸ -->
            <div class="control-panel h-full">
                <h2 class="section-title">è¾“å…¥æ–‡å­—</h2>
                <div class="mb-4 flex space-x-4">
                    <button id="example-1" class="text-sm text-primary-color hover:text-hover-color">
                        ç¤ºä¾‹1
                    </button>
                    <button id="example-2" class="text-sm text-primary-color hover:text-hover-color">
                        ç¤ºä¾‹2
                    </button>
                    <button id="example-3" class="text-sm text-primary-color hover:text-hover-color">
                        ç¤ºä¾‹3
                    </button>
                </div>
                <textarea id="text-input" 
                    class="w-full h-[calc(100%-80px)] p-4 border border-border-color rounded-lg resize-none focus:ring-2 focus:ring-primary-color focus:border-transparent"
                    placeholder="åœ¨æ­¤è¾“å…¥æ–‡å­—å†…å®¹ï¼Œæ”¯æŒMarkdownæ ¼å¼ï¼ˆå¦‚ï¼š# æ ‡é¢˜ã€**ç²—ä½“**ã€> å¼•ç”¨ç­‰ï¼‰..."></textarea>
            </div>

            <!-- å³ä¾§ï¼šå‚æ•°è®¾ç½®åŒºåŸŸ -->
            <div class="control-panel h-full">
                <h2 class="section-title">æ ·å¼è®¾ç½®</h2>
                <div class="grid grid-cols-1 gap-4 h-[calc(100%-48px)] overflow-y-auto">
                    <!-- èƒŒæ™¯é¢œè‰²/æ¨¡æ¿é€‰æ‹© -->
                    <div>
                        <h3 class="input-label">é€‰æ‹©æ¨¡æ¿</h3>
                        <div class="grid grid-cols-4 gap-2">
                            <!-- æ¸…æ–°ç®€çº¦ -->
                            <div class="template-option selected" data-template="clean" 
                                data-bg-color="#FFFFFF" data-text-color="#2C3E50" data-name="æ¸…æ–°ç®€çº¦" data-custom="true">
                                <div class="h-16 bg-white rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">æ¸…æ–°ç®€çº¦</p>
                            </div>
                            
                            <!-- ä¼˜é›…ç±³è‰² -->
                            <div class="template-option" data-template="elegant"
                                data-bg-color="#F8F4F0" data-text-color="#2C3E50" data-name="ä¼˜é›…ç±³è‰²" data-custom="false">
                                <div class="h-16 bg-[#F8F4F0] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">ä¼˜é›…ç±³è‰²</p>
                            </div>
                            
                            <!-- æ·±é‚ƒå¤œç©º -->
                            <div class="template-option" data-template="dark"
                                data-bg-color="#1A1A1A" data-text-color="#FFFFFF" data-name="æ·±é‚ƒå¤œç©º" data-custom="false">
                                <div class="h-16 bg-[#1A1A1A] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">æ·±é‚ƒå¤œç©º</p>
                            </div>
                            
                            <!-- è–„è·æ¸…æ–° -->
                            <div class="template-option" data-template="mint"
                                data-bg-color="#E8F5E9" data-text-color="#2C3E50" data-name="è–„è·æ¸…æ–°" data-custom="false">
                                <div class="h-16 bg-[#E8F5E9] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">è–„è·æ¸…æ–°</p>
                            </div>
                            
                            <!-- å¤©ç©ºè“ -->
                            <div class="template-option" data-template="sky"
                                data-bg-color="#E3F2FD" data-text-color="#2C3E50" data-name="å¤©ç©ºè“" data-custom="false">
                                <div class="h-16 bg-[#E3F2FD] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">å¤©ç©ºè“</p>
                            </div>
                            
                            <!-- æš–é˜³æ©™ -->
                            <div class="template-option" data-template="sunset"
                                data-bg-color="#FFF3E0" data-text-color="#2C3E50" data-name="æš–é˜³æ©™" data-custom="false">
                                <div class="h-16 bg-[#FFF3E0] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">æš–é˜³æ©™</p>
                            </div>
                            
                            <!-- æµ…ç²‰çº¢ -->
                            <div class="template-option" data-template="pink"
                                data-bg-color="#FCE4EC" data-text-color="#2C3E50" data-name="æµ…ç²‰çº¢" data-custom="false">
                                <div class="h-16 bg-[#FCE4EC] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">æµ…ç²‰çº¢</p>
                            </div>
                            
                            <!-- æ·¡ç´«è‰² -->
                            <div class="template-option" data-template="lavender"
                                data-bg-color="#F3E5F5" data-text-color="#2C3E50" data-name="æ·¡ç´«è‰²" data-custom="false">
                                <div class="h-16 bg-[#F3E5F5] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">æ·¡ç´«è‰²</p>
                            </div>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰èƒŒæ™¯é¢œè‰² -->
                    <div class="mt-4">
                        <label class="input-label">è‡ªå®šä¹‰èƒŒæ™¯é¢œè‰²</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="bg-color" value="#FFFFFF" class="w-full h-10 rounded-lg cursor-pointer">
                            <div class="bg-white px-3 py-2 rounded-lg border border-gray-200 min-w-[90px] text-sm text-gray-600" id="color-value">
                                #FFFFFF
                            </div>
                        </div>
                    </div>

                    <!-- åº•åº§é¢œè‰² -->
                    <div>
                        <h3 class="input-label">åº•åº§é¢œè‰²</h3>
                        <div class="flex flex-wrap gap-2">
                            <div class="gradient-option selected" data-gradient="none" style="background: #e5e7eb;">
                                <span class="text-red-500 text-2xl flex items-center justify-center h-full">ğŸš«</span>
                            </div>
                            <div class="gradient-option base-color-1" data-gradient="base-color-1"></div>
                            <div class="gradient-option base-color-2" data-gradient="base-color-2"></div>
                            <div class="gradient-option base-color-3" data-gradient="base-color-3"></div>
                            <div class="gradient-option base-color-4" data-gradient="base-color-4"></div>
                            <div class="gradient-option base-color-5" data-gradient="base-color-5"></div>
                            <div class="gradient-option base-color-6" data-gradient="base-color-6"></div>
                            <div class="gradient-option base-color-7" data-gradient="base-color-7"></div>
                            <div class="gradient-option base-color-8" data-gradient="base-color-8"></div>
                            <div class="gradient-option base-color-9" data-gradient="base-color-9"></div>
                        </div>
                    </div>

                    <!-- å­—ä½“è®¾ç½® -->
                    <div>
                        <label class="input-label">å­—ä½“é€‰æ‹©</label>
                        <select id="font-family" class="w-full border border-gray-300 rounded-lg p-2">
                            <!-- æ— è¡¬çº¿å­—ä½“ -->
                            <optgroup label="æ— è¡¬çº¿å­—ä½“">
                                <option value="system-ui, -apple-system">ç³»ç»Ÿé»˜è®¤</option>
                                <option value="'PingFang SC', 'Microsoft YaHei'">è‹¹æ–¹ / å¾®è½¯é›…é»‘</option>
                                <option value="'Noto Sans SC'">æ€æºé»‘ä½“</option>
                                <option value="'Helvetica Neue', Arial">Helvetica</option>
                            </optgroup>
                            <!-- è¡¬çº¿å­—ä½“ -->
                            <optgroup label="è¡¬çº¿å­—ä½“">
                                <option value="'SimSun', serif">å®‹ä½“</option>
                                <option value="'SimKai', serif">æ¥·ä½“</option>
                                <option value="'SimHei', sans-serif">é»‘ä½“</option>
                                <option value="'FangSong', serif">ä»¿å®‹</option>
                            </optgroup>
                            <!-- ç‰¹æ®Šå­—ä½“ -->
                            <optgroup label="ç‰¹æ®Šå­—ä½“">
                                <option value="'LXGW WenKai'">éœé¹œæ–‡æ¥·</option>
                                <option value="'Zhi Mang Xing'">æ™ºæ…§ä½“</option>
                                <option value="'Ma Shan Zheng'">é©¬å–„æ”¿ä½“</option>
                            </optgroup>
                        </select>
                    </div>

                    <div>
                        <label class="input-label">å­—ä½“å¤§å°</label>
                        <input type="number" id="font-size" value="16" min="12" max="72" 
                            class="w-full border border-gray-300 rounded-lg p-2">
                    </div>

                    <!-- å…¶ä»–è®¾ç½® -->
                    <div>
                        <label class="input-label">å›¾ç‰‡æ¯”ä¾‹</label>
                        <select id="aspect-ratio" class="w-full border border-gray-300 rounded-lg p-2">
                            <option value="auto">è‡ªç”±æ¯”ä¾‹</option>
                            <option value="1:1">1:1 æ­£æ–¹å½¢</option>
                            <option value="4:3">4:3 æ¨ªç‰ˆ</option>
                            <option value="16:9">16:9 å®½å±</option>
                            <option value="3:4">3:4 ç«–ç‰ˆ</option>
                            <option value="9:16">9:16 æ‰‹æœºå±</option>
                        </select>
                    </div>

                    <div>
                        <label class="input-label">è‡ªåŠ¨åˆ†å‰²é•¿æ–‡æœ¬</label>
                        <div class="flex items-center">
                            <input type="checkbox" id="auto-split" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-600">è‡ªåŠ¨å°†é•¿æ–‡æœ¬åˆ†å‰²æˆå¤šå¼ å¡ç‰‡</span>
                        </div>
                    </div>

                    <!-- åœ¨æ ·å¼è®¾ç½®åŒºåŸŸæ·»åŠ å¡ç‰‡å¤§å°è®¾ç½® -->
                    <div>
                        <label class="input-label">å¡ç‰‡å¤§å°</label>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="custom-size" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-600">è‡ªå®šä¹‰å¤§å°</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2" id="size-inputs">
                                <div>
                                    <label class="text-xs text-gray-500">å®½åº¦ (px)</label>
                                    <input type="number" id="card-width" value="800" min="200" max="2000" 
                                        class="w-full border border-gray-300 rounded-lg p-2 disabled:bg-gray-100 disabled:text-gray-500" disabled>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">é«˜åº¦ (px)</label>
                                    <input type="number" id="card-height" value="400" min="200" max="2000"
                                        class="w-full border border-gray-300 rounded-lg p-2 disabled:bg-gray-100 disabled:text-gray-500" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸‹éƒ¨åˆ†ï¼šé¢„è§ˆå’Œå¯¼å‡ºåŒºåŸŸ -->
        <div class="space-y-6">
            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div class="control-panel">
                <h2 class="section-title text-center">é¢„è§ˆ</h2>
                <div class="preview-container">
                    <div id="card-preview" class="card-preview"></div>
                </div>
            </div>

            <!-- å¯¼å‡ºæŒ‰é’®åŒºåŸŸ -->
            <div class="flex justify-center space-x-4 mt-6">
                <button id="download-png" 
                    data-format="png"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center">
                    <span class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        å¯¼å‡ºä¸ºPNG
                    </span>
                </button>
                <button id="download-jpg"
                    data-format="jpg"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center">
                    <span class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        å¯¼å‡ºä¸ºJPG
                    </span>
                </button>
            </div>
            
            <!-- å¯¼å‡ºæç¤º -->
            <div class="text-center mt-4 text-sm text-gray-500">
                <p>æç¤ºï¼šå¯¼å‡ºçš„å›¾ç‰‡å°†ä¿æŒåŸå§‹æ¯”ä¾‹å’Œè´¨é‡</p>
            </div>
        </div>
    </div>
</div>

<script>
// åˆå§‹åŒ–é¢„è§ˆ
function initPreview() {
    const preview = document.getElementById('card-preview');
    preview.style.minHeight = window.innerWidth > 1024 ? '400px' : '250px';
    updatePreview();
}

// è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
function setButtonLoading(button, loading) {
    if (!button) return;
    
    const format = button.getAttribute('data-format');
    const originalText = `å¯¼å‡ºä¸º${format.toUpperCase()}`;
    
    button.disabled = loading;
    button.innerHTML = loading ? 
        `<span class="loading"></span> å¯¼å‡ºä¸­...` : 
        `<span class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            ${originalText}
        </span>`;
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    const bgColor = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
    }[type] || 'bg-blue-500';
    
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${bgColor} text-white`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// å¯¼å‡ºå›¾ç‰‡
async function exportToImage(format) {
    const preview = document.getElementById('card-preview');
    const button = document.getElementById(`download-${format}`);
    
    try {
        setButtonLoading(button, true);
        
        // è·å–å¡ç‰‡å®é™…å†…å®¹åŒºåŸŸçš„å°ºå¯¸å’Œæ ·å¼
        const cardStyle = window.getComputedStyle(preview);
        const width = preview.offsetWidth;
        const height = preview.offsetHeight;
        
        // åˆ›å»ºä¸´æ—¶å®¹å™¨ï¼ŒåªåŒ…å«å¡ç‰‡å†…å®¹
        const tempWrapper = document.createElement('div');
        tempWrapper.style.cssText = `
            position: fixed;
            left: -9999px;
            top: -9999px;
            width: ${width}px;
            height: ${height}px;
            background-color: ${format === 'jpg' ? '#ffffff' : 'transparent'};
            overflow: hidden;
            border-radius: ${cardStyle.borderRadius};
        `;
        document.body.appendChild(tempWrapper);
        
        // å…‹éš†é¢„è§ˆå†…å®¹ï¼ˆåŒ…å«æ°´å°ï¼‰
        const clonedContent = preview.cloneNode(true);
        
        // å¤åˆ¶æ‰€æœ‰è®¡ç®—åçš„æ ·å¼
        const computedStyle = window.getComputedStyle(preview);
        Array.from(computedStyle).forEach(key => {
            clonedContent.style[key] = computedStyle[key];
        });
        
        // ç¡®ä¿å°ºå¯¸å’Œä½ç½®æ­£ç¡®
        clonedContent.style.cssText += `
            width: ${width}px;
            height: ${height}px;
            margin: 0;
            position: relative;
            transform: none;
            border-radius: ${cardStyle.borderRadius};
            background: ${cardStyle.background};
        `;
        
        // å°†å…‹éš†çš„å†…å®¹æ·»åŠ åˆ°ä¸´æ—¶å®¹å™¨
        tempWrapper.appendChild(clonedContent);
        
        // é…ç½®html2canvas
        const canvas = await html2canvas(tempWrapper, {
            scale: 1, // ä¿æŒåŸå§‹å°ºå¯¸
            useCORS: true, // æ”¯æŒè·¨åŸŸå›¾ç‰‡
            backgroundColor: format === 'jpg' ? '#ffffff' : null,
            logging: false,
            allowTaint: true,
            width: width,
            height: height,
            imageTimeout: 0,
            removeContainer: true,
            onclone: function(clonedDoc) {
                // ç¡®ä¿æ¸å˜å’Œæ ·å¼æ­£ç¡®åº”ç”¨
                const clonedElement = clonedDoc.querySelector('#card-preview');
                if (clonedElement) {
                    clonedElement.style.cssText = clonedContent.style.cssText;
                }
            }
        });
        
        // æ¸…ç†ä¸´æ—¶å®¹å™¨
        document.body.removeChild(tempWrapper);
        
        // è½¬æ¢ä¸ºblobå¹¶ä¸‹è½½
        canvas.toBlob(function(blob) {
            if (!blob) {
                throw new Error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥');
            }
            
            const timestamp = new Date().getTime();
            const filename = `text-card-${width}x${height}-${timestamp}.${format}`;
            
            saveAs(blob, filename);
            showToast('å¯¼å‡ºæˆåŠŸï¼', 'success');
        }, format === 'png' ? 'image/png' : 'image/jpeg', format === 'jpg' ? 0.92 : undefined);
        
    } catch (error) {
        console.error('å¯¼å‡ºå›¾ç‰‡å¤±è´¥:', error);
        showToast(`å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

// è‡ªåŠ¨åˆ†å‰²é•¿æ–‡æœ¬
function splitLongText(text) {
    if (!document.getElementById('auto-split').checked) return [text];
    
    const maxLength = 500; // æ¯å¼ å¡ç‰‡çš„æœ€å¤§å­—ç¬¦æ•°
    const paragraphs = text.split('\n\n');
    const cards = [];
    let currentCard = '';
    
    for (const paragraph of paragraphs) {
        if (currentCard.length + paragraph.length > maxLength) {
            if (currentCard) cards.push(currentCard.trim());
            currentCard = paragraph;
        } else {
            currentCard += (currentCard ? '\n\n' : '') + paragraph;
        }
    }
    
    if (currentCard) cards.push(currentCard.trim());
    return cards;
}

// ç¤ºä¾‹æ–‡æœ¬
const examples = {
    example1: `# å¿ƒçµé¸¡æ±¤

> ç”Ÿæ´»ä¸æ˜¯ç­‰å¾…æš´é£é›¨è¿‡å»ï¼Œè€Œæ˜¯å­¦ä¼šåœ¨é›¨ä¸­ç¿©ç¿©èµ·èˆã€‚

**æ¯ä¸€ä¸ªä¸æ›¾èµ·èˆçš„æ—¥å­ï¼Œéƒ½æ˜¯å¯¹ç”Ÿå‘½çš„è¾œè´Ÿã€‚**`,

    example2: `# å·¥ä½œç¬”è®°

## ä»Šæ—¥ä»»åŠ¡

- [x] å®Œæˆé¡¹ç›®æ–¹æ¡ˆ
- [x] å›¢é˜Ÿä¼šè®®
- [ ] ä»£ç å®¡æŸ¥

*deadline: 2024-03-20*`,

    example3: `# ç¾é£Ÿé£Ÿè°±

## çº¢çƒ§è‚‰

1. å‡†å¤‡é£Ÿæ
2. ç…¸ç‚’ç³–è‰²
3. åŠ å…¥è°ƒæ–™

*Tips: å°ç«æ…¢ç‚–æ›´å…¥å‘³*`
};

// åŠ è½½ç¤ºä¾‹æ–‡æœ¬
function loadExample(id) {
    const textarea = document.getElementById('text-input');
    textarea.value = examples[`example${id}`];
    updatePreview();
}

// æ›´æ–°é¢„è§ˆ
function updatePreview() {
    const preview = document.getElementById('card-preview');
    const previewContainer = document.querySelector('.preview-container');
    const selectedTemplate = document.querySelector('.template-option.selected');
    const isCustomTemplate = selectedTemplate.dataset.custom === 'true';
    const bgColorInput = document.getElementById('bg-color');
    const customSizeCheckbox = document.getElementById('custom-size');
    const width = parseInt(document.getElementById('card-width').value);
    const height = parseInt(document.getElementById('card-height').value);
    const fontFamily = document.getElementById('font-family').value;
    const fontSize = document.getElementById('font-size').value;
    
    // é‡ç½®é¢„è§ˆåŒºåŸŸ
    preview.innerHTML = '';
    preview.className = 'card-preview';
    
    // åˆ›å»ºå¹¶æ·»åŠ å­—ä½“æ ·å¼
    const fontStyle = document.createElement('style');
    fontStyle.setAttribute('data-type', 'custom-font');
    fontStyle.textContent = `
        .card-content {
            font-family: ${fontFamily} !important;
            font-size: ${fontSize}px !important;
            letter-spacing: 0.025em;
            text-rendering: optimizeLegibility;
        }
        .card-content * {
            font-family: inherit !important;
            letter-spacing: inherit;
        }
        /* æ ‡é¢˜ç‰¹æ®Šå¤„ç† */
        .card-content h1,
        .card-content h2,
        .card-content h3,
        .card-content h4,
        .card-content h5,
        .card-content h6 {
            font-weight: 700;
            line-height: 1.4;
        }
    `;
    document.head.appendChild(fontStyle);
    
    // æ·»åŠ åº•åº§é¢œè‰²ï¼ˆæœ€åº•å±‚ï¼‰
    const baseColor = document.querySelector('.gradient-option.selected').dataset.gradient;
    if (baseColor !== 'none') {
        const baseColorElement = document.createElement('div');
        baseColorElement.className = `base-color ${baseColor}`;
        preview.appendChild(baseColorElement);
    }
    
    // åˆ›å»ºå†…å®¹åŒ…è£…å™¨ï¼ˆä¸­é—´å±‚ï¼‰
    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'content-wrapper';
    preview.appendChild(contentWrapper);
    
    // åˆ›å»ºå†…å®¹å®¹å™¨ï¼ˆèƒŒæ™¯å±‚ï¼‰
    const contentContainer = document.createElement('div');
    contentContainer.className = 'bg-template';
    contentContainer.style.cssText = `
        padding-bottom: 40px; /* å¢åŠ åº•éƒ¨å†…è¾¹è·ï¼Œä¸ºæ°´å°ç•™å‡ºç©ºé—´ */
    `;
    contentWrapper.appendChild(contentContainer);
    
    // åˆ›å»ºæ°´å°å®¹å™¨ï¼ˆæœ€ä¸Šå±‚ï¼Œä½†åœ¨å†…å®¹å®¹å™¨å†…ï¼‰
    const watermarkContainer = document.createElement('div');
    watermarkContainer.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
    `;
    contentContainer.appendChild(watermarkContainer);
    
    // æ·»åŠ æ—¶é—´æ°´å°
    const dateWatermark = document.createElement('div');
    const now = new Date();
    const dateStr = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`;
    dateWatermark.style.cssText = `
        position: absolute;
        top: 12px;
        left: 12px;
        font-size: 12px;
        color: rgba(0, 0, 0, 0.3);
        z-index: 20;
    `;
    dateWatermark.textContent = dateStr;
    watermarkContainer.appendChild(dateWatermark);
    
    // æ·»åŠ ç‰ˆæƒæ°´å°
    const copyrightWatermark = document.createElement('div');
    copyrightWatermark.style.cssText = `
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        color: rgba(0, 0, 0, 0.3);
        z-index: 20;
    `;
    copyrightWatermark.textContent = '@Generate By MEDIAS.AI';
    watermarkContainer.appendChild(copyrightWatermark);
    
    // æ·»åŠ å­—æ•°ç»Ÿè®¡æ°´å°
    const textContent = document.getElementById('text-input').value;
    const wordCount = textContent.replace(/\s/g, '').length;
    const wordCountWatermark = document.createElement('div');
    wordCountWatermark.style.cssText = `
        position: absolute;
        bottom: 16px;
        right: 12px;
        font-size: 12px;
        color: rgba(0, 0, 0, 0.3);
        z-index: 20;
    `;
    wordCountWatermark.textContent = `å­—æ•°ï¼š${wordCount}`;
    watermarkContainer.appendChild(wordCountWatermark);

    // è®¾ç½®é¢„è§ˆå°ºå¯¸
    if (customSizeCheckbox.checked && !isNaN(width) && !isNaN(height)) {
        preview.style.width = `${width}px`;
        preview.style.height = `${height}px`;
        preview.style.minHeight = `${height}px`;
        previewContainer.style.minWidth = `${width + 80}px`;
        previewContainer.style.minHeight = `${height + 80}px`;
    }

    // æ·»åŠ å®é™…å†…å®¹
    const text = document.getElementById('text-input').value;
    const cards = splitLongText(text);

    cards.forEach((cardText, index) => {
        if (index > 0) {
            const pageDivider = document.createElement('div');
            pageDivider.className = 'border-t border-gray-200 my-4';
            contentContainer.appendChild(pageDivider);
        }

        const cardElement = document.createElement('div');
        cardElement.className = 'card-content markdown-body custom-font';
        cardElement.innerHTML = marked.parse(cardText);
        cardElement.style.cssText = `
            font-family: ${fontFamily} !important;
            font-size: ${fontSize}px;
        `;
        contentContainer.appendChild(cardElement);
    });

    // è®¾ç½®èƒŒæ™¯é¢œè‰²å’Œæ–‡å­—é¢œè‰²
    if (isCustomTemplate) {
        preview.style.setProperty('--bg-color', bgColorInput.value);
    } else {
        preview.style.setProperty('--bg-color', selectedTemplate.dataset.bgColor);
        bgColorInput.value = selectedTemplate.dataset.bgColor;
    }
    
    // è®¾ç½®æ–‡å­—é¢œè‰²ï¼ˆå¯¹æ‰€æœ‰æ¨¡æ¿éƒ½ç”Ÿæ•ˆï¼‰
    document.documentElement.style.setProperty('--text-color', selectedTemplate.dataset.textColor);
    
    // å°†å†…å®¹å®¹å™¨æ·»åŠ åˆ°åŒ…è£…å™¨
    contentWrapper.appendChild(contentContainer);

    // åº”ç”¨æ¯”ä¾‹è®¾ç½®
    const ratio = document.getElementById('aspect-ratio').value;
    if (ratio !== 'auto') {
        const baseWidth = 800;
        const [width, height] = ratio.split(':').map(Number);
        const calculatedHeight = Math.round((baseWidth * height) / width);
        
        preview.style.width = `${baseWidth}px`;
        preview.style.height = `${calculatedHeight}px`;
        
        // æ›´æ–°é¢„è§ˆå®¹å™¨å°ºå¯¸
        previewContainer.style.minWidth = `${baseWidth + 80}px`;
        previewContainer.style.minHeight = `${calculatedHeight + 80}px`;
    }

    // å°†åŒ…è£…å™¨æ·»åŠ åˆ°é¢„è§ˆåŒºåŸŸ
    preview.appendChild(contentWrapper);

    // æ¸…ç†ä¹‹å‰çš„å­—ä½“æ ·å¼
    return () => {
        if (document.head.contains(fontStyle)) {
            document.head.removeChild(fontStyle);
        }
    };
}

// æ¨¡æ¿é€‰æ‹©äº‹ä»¶å¤„ç†
document.querySelectorAll('.template-option').forEach(option => {
    option.addEventListener('click', function() {
        // ç§»é™¤å…¶ä»–æ¨¡æ¿çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.template-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // æ·»åŠ å½“å‰æ¨¡æ¿çš„é€‰ä¸­çŠ¶æ€
        this.classList.add('selected');
        
        // è·å–æ¨¡æ¿æ•°æ®
        const bgColor = this.dataset.bgColor;
        const textColor = this.dataset.textColor;
        const isCustom = this.dataset.custom === 'true';
        
        // æ›´æ–°èƒŒæ™¯è‰²è¾“å…¥æ¡†å’Œé¢„è§ˆ
        const bgColorInput = document.getElementById('bg-color');
        bgColorInput.value = bgColor;
        bgColorInput.disabled = !isCustom;
        
        // æ›´æ–°é¢œè‰²å€¼æ˜¾ç¤º
        const colorValueDisplay = document.getElementById('color-value');
        colorValueDisplay.textContent = bgColor.toUpperCase();
        
        // æ›´æ–°CSSå˜é‡
        const preview = document.getElementById('card-preview');
        preview.style.setProperty('--bg-color', bgColor);
        document.documentElement.style.setProperty('--text-color', textColor);
        
        updatePreview();
    });
});

// ç›‘å¬æ¸å˜é€‰æ‹©
document.querySelectorAll('.gradient-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.gradient-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        this.classList.add('selected');
        updatePreview();
    });
});

// ç›‘å¬å…¶ä»–è®¾ç½®å˜åŒ–
// å­—ä½“é€‰æ‹©å®æ—¶æ›´æ–°
document.getElementById('font-family').addEventListener('change', function() {
    // æ¸…é™¤ä¹‹å‰çš„å­—ä½“æ ·å¼
    const oldFontStyles = document.querySelectorAll('style[data-type="custom-font"]');
    oldFontStyles.forEach(style => style.remove());
    
    updatePreview();
});

// å­—ä½“å¤§å°å®æ—¶æ›´æ–°
const fontSizeInput = document.getElementById('font-size');
fontSizeInput.addEventListener('input', updatePreview);
fontSizeInput.addEventListener('change', updatePreview);

// èƒŒæ™¯é¢œè‰²å˜åŒ–æ—¶çš„å¤„ç†
const bgColorInput = document.getElementById('bg-color');
const colorValueDisplay = document.getElementById('color-value');

bgColorInput.addEventListener('input', function() {
    // å½“èƒŒæ™¯é¢œè‰²æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°è‡ªå®šä¹‰æ¨¡æ¿
    const customTemplate = document.querySelector('.template-option[data-template="clean"]');
    if (!customTemplate.classList.contains('selected')) {
        document.querySelectorAll('.template-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        customTemplate.classList.add('selected');
    }
    
    // ç›´æ¥æ›´æ–°CSSå˜é‡
    const preview = document.getElementById('card-preview');
    preview.style.setProperty('--bg-color', this.value);
    document.documentElement.style.setProperty('--text-color', customTemplate.dataset.textColor);
    
    // æ›´æ–°é¢œè‰²å€¼æ˜¾ç¤º
    colorValueDisplay.textContent = this.value.toUpperCase();
    
    updatePreview();
});

// ä¿®æ”¹å›¾ç‰‡æ¯”ä¾‹å˜åŒ–çš„äº‹ä»¶å¤„ç†
document.getElementById('aspect-ratio').addEventListener('change', function() {
    const preview = document.getElementById('card-preview');
    const ratio = this.value;
    const customSizeCheckbox = document.getElementById('custom-size');
    const cardWidth = document.getElementById('card-width');
    const cardHeight = document.getElementById('card-height');
    const previewContainer = document.querySelector('.preview-container');
    
    // è·å–é¢„è§ˆåŒºåŸŸçš„åŸºå‡†å®½åº¦
    const baseWidth = 800;
    
    if (ratio === 'auto') {
        preview.style.aspectRatio = 'auto';
        preview.style.width = '';
        preview.style.height = '';
        previewContainer.style.minWidth = '';
        previewContainer.style.minHeight = '300px';
        
        // å…è®¸è‡ªå®šä¹‰å¤§å°
        customSizeCheckbox.disabled = false;
        customSizeCheckbox.parentElement.classList.remove('opacity-50');
    } else {
        const [width, height] = ratio.split(':').map(Number);
        // è®¡ç®—å¯¹åº”çš„é«˜åº¦
        const calculatedHeight = Math.round((baseWidth * height) / width);
        
        // ç«‹å³åº”ç”¨å°ºå¯¸
        preview.style.width = `${baseWidth}px`;
        preview.style.height = `${calculatedHeight}px`;
        preview.style.aspectRatio = `${width}/${height}`;
        
        // ç«‹å³æ›´æ–°é¢„è§ˆå®¹å™¨å°ºå¯¸
        previewContainer.style.minWidth = `${baseWidth + 80}px`;
        previewContainer.style.minHeight = `${calculatedHeight + 80}px`;
        
        // ç«‹å³æ›´æ–°å°ºå¯¸è¾“å…¥æ¡†çš„å€¼
        cardWidth.value = baseWidth;
        cardHeight.value = calculatedHeight;
        
        // ç¦ç”¨è‡ªå®šä¹‰å¤§å°
        customSizeCheckbox.checked = false;
        customSizeCheckbox.disabled = true;
        customSizeCheckbox.parentElement.classList.add('opacity-50');
        // ç¦ç”¨å°ºå¯¸è¾“å…¥
        cardWidth.disabled = true;
        cardHeight.disabled = true;
    }
    
    // ç«‹å³æ›´æ–°é¢„è§ˆ
    updatePreview();
    
    // ç¡®ä¿æ¯”ä¾‹åº”ç”¨åçš„å†…å®¹å¸ƒå±€æ­£ç¡®
    setTimeout(() => {
        updatePreview();
    }, 100);
});

// ç›‘å¬è‡ªåŠ¨åˆ†å‰²å¼€å…³
document.getElementById('auto-split').addEventListener('change', updatePreview);

// ç»‘å®šå¯¼å‡ºæŒ‰é’®äº‹ä»¶
document.getElementById('download-png').addEventListener('click', () => exportToImage('png'));
document.getElementById('download-jpg').addEventListener('click', () => exportToImage('jpg'));

// ç»‘å®šç¤ºä¾‹æŒ‰é’®äº‹ä»¶
document.getElementById('example-1').addEventListener('click', () => loadExample(1));
document.getElementById('example-2').addEventListener('click', () => loadExample(2));
document.getElementById('example-3').addEventListener('click', () => loadExample(3));

// åˆå§‹åŒ–é¢„è§ˆ
updatePreview();

// åˆå§‹åŒ–æ—¶è®¾ç½®é¢œè‰²å€¼æ˜¾ç¤º
document.addEventListener('DOMContentLoaded', function() {
    colorValueDisplay.textContent = bgColorInput.value.toUpperCase();
});

// ç›‘å¬æ–‡æœ¬è¾“å…¥ï¼Œè‡ªåŠ¨è°ƒæ•´å¡ç‰‡å¤§å°
const textInput = document.getElementById('text-input');
textInput.addEventListener('input', function() {
    if (!customSizeCheckbox.checked) {
        // åªåœ¨éè‡ªå®šä¹‰å¤§å°æ¨¡å¼ä¸‹è‡ªåŠ¨è°ƒæ•´
        const preview = document.getElementById('card-preview');
        preview.style.width = '';
        preview.style.height = '';
    }
    updatePreview();
});

// è‡ªå®šä¹‰å¤§å°ç›¸å…³çš„äº‹ä»¶å¤„ç†
const customSizeCheckbox = document.getElementById('custom-size');
const sizeInputs = document.getElementById('size-inputs');
const cardWidth = document.getElementById('card-width');
const cardHeight = document.getElementById('card-height');

// ç›‘å¬è‡ªå®šä¹‰å¤§å°å¼€å…³
customSizeCheckbox.addEventListener('change', function() {
    // æ£€æŸ¥æ˜¯å¦ä¸ºè‡ªç”±æ¯”ä¾‹
    const aspectRatio = document.getElementById('aspect-ratio').value;
    if (aspectRatio !== 'auto') {
        this.checked = false;
        return;
    }
    
    cardWidth.disabled = !this.checked;
    cardHeight.disabled = !this.checked;
    
    if (!this.checked) {
        const preview = document.getElementById('card-preview');
        preview.style.width = '';
        preview.style.height = '';
        
        // é‡ç½®é¢„è§ˆå®¹å™¨å°ºå¯¸
        const previewContainer = document.querySelector('.preview-container');
        previewContainer.style.minWidth = '';
        previewContainer.style.minHeight = '300px';
    } else {
        // åˆ‡æ¢åˆ°è‡ªå®šä¹‰æ¨¡å¼æ—¶ï¼Œä½¿ç”¨å½“å‰å®é™…å°ºå¯¸ä½œä¸ºåˆå§‹å€¼
        const actualWidth = Math.round(preview.offsetWidth);
        const actualHeight = Math.round(preview.offsetHeight);
        cardWidth.value = actualWidth;
        cardHeight.value = actualHeight;
        
        // ç«‹å³åº”ç”¨è¿™äº›å°ºå¯¸
        preview.style.width = `${actualWidth}px`;
        preview.style.height = `${actualHeight}px`;
        previewContainer.style.minWidth = `${actualWidth + 80}px`;
        previewContainer.style.minHeight = `${actualHeight + 80}px`;
    }
    
    updatePreview();
});

// ç›‘å¬å®½åº¦è¾“å…¥
cardWidth.addEventListener('input', function() {
    if (!customSizeCheckbox.checked) return;
    
    const width = parseInt(this.value);
    if (isNaN(width) || width < 200 || width > 2000) return;
    
    const preview = document.getElementById('card-preview');
    const previewContainer = document.querySelector('.preview-container');
    
    // åº”ç”¨æ–°å®½åº¦
    preview.style.width = `${width}px`;
    previewContainer.style.minWidth = `${width + 80}px`;
    
    // è§¦å‘ä¸€æ¬¡å®Œæ•´çš„é¢„è§ˆæ›´æ–°
    updatePreview();
});

// ç›‘å¬é«˜åº¦è¾“å…¥
cardHeight.addEventListener('input', function() {
    if (!customSizeCheckbox.checked) return;
    
    const height = parseInt(this.value);
    if (isNaN(height) || height < 200 || height > 2000) return;
    
    const preview = document.getElementById('card-preview');
    const previewContainer = document.querySelector('.preview-container');
    
    // åº”ç”¨æ–°é«˜åº¦
    preview.style.height = `${height}px`;
    previewContainer.style.minHeight = `${height + 80}px`;
    
    // è§¦å‘ä¸€æ¬¡å®Œæ•´çš„é¢„è§ˆæ›´æ–°
    updatePreview();
});

// åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    // ... å…¶ä»–åˆå§‹åŒ–ä»£ç  ...
    
    // åˆå§‹åŒ–å›¾ç‰‡æ¯”ä¾‹å’Œè‡ªå®šä¹‰å¤§å°çš„è”åŠ¨çŠ¶æ€
    const aspectRatio = document.getElementById('aspect-ratio').value;
    const customSizeCheckbox = document.getElementById('custom-size');
    
    if (aspectRatio !== 'auto') {
        customSizeCheckbox.checked = false;
        customSizeCheckbox.disabled = true;
        customSizeCheckbox.parentElement.classList.add('opacity-50');
    }

    // æ·»åŠ å­—ä½“åŠ è½½æ£€æµ‹
    checkFontLoading();
});

// æ·»åŠ loadingæ ·å¼
const style = document.createElement('style');
style.textContent = `
.loading {
    display: inline-block;
    width: 1em;
    height: 1em;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
    margin-right: 0.5em;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
`;
document.head.appendChild(style);

// æ·»åŠ å­—ä½“åŠ è½½æ£€æµ‹
function checkFontLoading() {
    const fontFamilies = [
        'Noto Sans SC',
        'LXGW WenKai',
        'Zhi Mang Xing',
        'Ma Shan Zheng'
    ];

    Promise.all(fontFamilies.map(font => document.fonts.load(`1em "${font}"`)))
        .then(() => {
            console.log('æ‰€æœ‰å­—ä½“åŠ è½½å®Œæˆ');
            updatePreview();
        })
        .catch(err => {
            console.warn('éƒ¨åˆ†å­—ä½“åŠ è½½å¤±è´¥:', err);
            updatePreview();
        });
}
</script>
{% endblock %} 