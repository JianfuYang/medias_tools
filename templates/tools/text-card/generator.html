{% extends "common/base.html" %}

{% block title %}文字卡片生成器 - 媒体效率工具库{% endblock %}

{% block head %}
{{ super() }}
<!-- 引入 Marked.js 用于Markdown解析 -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- 引入 html2canvas 用于生成图片 -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!-- 引入 FileSaver.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<!-- 引入思源黑体 -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
<!-- 引入苹果风格字体 -->
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap" rel="stylesheet">
<!-- 引入 GitHub Markdown 样式 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">

<style>
/* 全局样式 */
:root {
    --primary-color: #0071e3;
    --hover-color: #0077ed;
    --bg-color: #ffffff;
    --text-color: #2C3E50;  /* 默认文字颜色 */
    --secondary-text: #86868b;
    --border-color: #d2d2d7;
}

body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
}

.card-preview {
    min-height: 200px;
    max-width: 800px;
    margin: 0 auto;
    position: relative;
    background: var(--bg-color);
    border-radius: 14px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: all 0.3s ease;
    padding: 1.5rem;
    font-family: 'Noto Sans SC', sans-serif;
    display: flex;
    flex-direction: column;
}

.card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: var(--text-color);
    position: relative;
    z-index: 1;
}

.control-panel {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 14px;
    border: 1px solid var(--border-color);
    padding: 1.5rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-color);
}

.input-group {
    margin-bottom: 1.5rem;
}

.input-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--secondary-text);
    margin-bottom: 0.5rem;
}

.template-option {
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.template-option:hover {
    transform: translateY(-2px);
}

.template-option.selected {
    border-color: #3b82f6;
}

.gradient-option {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.gradient-option:hover {
    transform: scale(1.1);
}

.gradient-option.selected {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

/* 底座颜色样式 */
.base-color {
    position: absolute;
    inset: 0;
    border-radius: 14px;
    z-index: 0;
}

.base-color-1 { background: linear-gradient(45deg, #12c2e9, #c471ed, #f64f59); }
.base-color-2 { background: linear-gradient(45deg, #FF9A9E, #FAD0C4); }
.base-color-3 { background: linear-gradient(45deg, #a8edea, #fed6e3); }
.base-color-4 { background: linear-gradient(45deg, #d4fc79, #96e6a1); }
.base-color-5 { background: linear-gradient(45deg, #84fab0, #8fd3f4); }
.base-color-6 { background: linear-gradient(45deg, #a6c0fe, #f68084); }
.base-color-7 { background: linear-gradient(45deg, #fbc2eb, #a6c1ee); }
.base-color-8 { background: linear-gradient(45deg, #f6d365, #fda085); }
.base-color-9 { background: linear-gradient(45deg, #ffd1ff, #fad0c4); }

/* 预设模板样式 */
.content-wrapper {
    position: relative;
    margin: 12px;
    border-radius: 10px;
    background: var(--bg-color);
    color: var(--text-color);
    z-index: 1;
    height: calc(100% - 24px);
    padding: 1.5rem;
}

/* 渐变底座样式 */
.gradient-none {
    display: none;
}

.gradient-simple {
    height: 4px;
    background: linear-gradient(to right, #3b82f6, #60a5fa);
}

.gradient-elegant {
    height: 6px;
    background: linear-gradient(45deg, #f6d365, #fda085);
}

.gradient-modern {
    height: 8px;
    background: linear-gradient(to right, #4f46e5, #818cf8);
}

.gradient-1 {
    background: linear-gradient(45deg, #12c2e9, #c471ed, #f64f59);
    height: 4px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
}

.gradient-2 {
    background: linear-gradient(45deg, #FF9A9E, #FAD0C4);
    height: 4px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
}

.gradient-3 {
    background: linear-gradient(45deg, #a8edea, #fed6e3);
}

.gradient-4 {
    background: linear-gradient(45deg, #d4fc79, #96e6a1);
}

.gradient-5 {
    background: linear-gradient(45deg, #84fab0, #8fd3f4);
}

.gradient-6 {
    background: linear-gradient(45deg, #a6c0fe, #f68084);
}

.gradient-7 {
    background: linear-gradient(45deg, #fbc2eb, #a6c1ee);
}

.gradient-8 {
    background: linear-gradient(45deg, #f6d365, #fda085);
}

.gradient-9 {
    background: linear-gradient(45deg, #ffd1ff, #fad0c4);
}

/* 预设模板/背景颜色 */
.bg-template {
    padding: 1.5rem;
    height: 100%;
    width: 100%;
}

/* 调整预览区域在移动端的位置 */
@media (max-width: 1024px) {
    .card-preview {
        min-height: 250px;
    }
}

/* Markdown 样式定制 */
.markdown-body {
    font-family: inherit;
    font-size: inherit;
    line-height: 1.6;
    color: var(--text-color);
    background-color: transparent;
}

.markdown-body h1 {
    font-size: 1.75em;
    border-bottom: none;
    padding-bottom: 0.3em;
    margin-bottom: 0.75em;
}

.markdown-body h2 {
    font-size: 1.5em;
    border-bottom: none;
    padding-bottom: 0.3em;
    margin-bottom: 0.75em;
}

.markdown-body blockquote {
    border-left: 4px solid currentColor;
    opacity: 0.8;
    margin: 1em 0;
    padding: 0 1em;
}

.markdown-body ul,
.markdown-body ol {
    padding-left: 1.5em;
    margin: 0.5em 0;
}

.markdown-body code {
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
    padding: 0.2em 0.4em;
}

.markdown-body pre {
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 6px;
    padding: 1em;
    margin: 1em 0;
}

/* 添加预览区域容器样式 */
.preview-container {
    width: 100%;
    padding: 2rem;
    background-color: #f8f9fa;
    border-radius: 1rem;
    margin-top: 2rem;
    overflow: auto;
    min-height: 300px;
}

/* 预加载字体 */
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=LXGW+WenKai:wght@400;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');

/* 定义字体回退方案 */
.card-content {
    font-feature-settings: "liga" 0;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-12">
    <!-- 标题区域 -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-semibold mb-4">文字卡片生成器</h1>
        <p class="text-lg text-secondary-text max-w-2xl mx-auto">
            创建优雅美观的文字卡片，支持Markdown格式，适合社交媒体分享或个人使用。最佳文字图工具 <a href="https://midjourney.com" class="text-blue-600 hover:underline" target="_blank">Midjourney</a>
        </p>
    </div>

    <!-- 主要内容区域：上下布局 -->
    <div class="space-y-8">
        <!-- 上部分：输入和参数设置区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 左侧：文本输入区域 -->
            <div class="control-panel h-full">
                <h2 class="section-title">输入文字</h2>
                <div class="mb-4 flex space-x-4">
                    <button id="example-1" class="text-sm text-primary-color hover:text-hover-color">
                        示例1
                    </button>
                    <button id="example-2" class="text-sm text-primary-color hover:text-hover-color">
                        示例2
                    </button>
                    <button id="example-3" class="text-sm text-primary-color hover:text-hover-color">
                        示例3
                    </button>
                </div>
                <textarea id="text-input" 
                    class="w-full h-[calc(100%-80px)] p-4 border border-border-color rounded-lg resize-none focus:ring-2 focus:ring-primary-color focus:border-transparent"
                    placeholder="在此输入文字内容，支持Markdown格式（如：# 标题、**粗体**、> 引用等）..."></textarea>
            </div>

            <!-- 右侧：参数设置区域 -->
            <div class="control-panel h-full">
                <h2 class="section-title">样式设置</h2>
                <div class="grid grid-cols-1 gap-4 h-[calc(100%-48px)] overflow-y-auto">
                    <!-- 背景颜色/模板选择 -->
                    <div>
                        <h3 class="input-label">选择模板</h3>
                        <div class="grid grid-cols-4 gap-2">
                            <!-- 清新简约 -->
                            <div class="template-option selected" data-template="clean" 
                                data-bg-color="#FFFFFF" data-text-color="#2C3E50" data-name="清新简约" data-custom="true">
                                <div class="h-16 bg-white rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">清新简约</p>
                            </div>
                            
                            <!-- 优雅米色 -->
                            <div class="template-option" data-template="elegant"
                                data-bg-color="#F8F4F0" data-text-color="#2C3E50" data-name="优雅米色" data-custom="false">
                                <div class="h-16 bg-[#F8F4F0] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">优雅米色</p>
                            </div>
                            
                            <!-- 深邃夜空 -->
                            <div class="template-option" data-template="dark"
                                data-bg-color="#1A1A1A" data-text-color="#FFFFFF" data-name="深邃夜空" data-custom="false">
                                <div class="h-16 bg-[#1A1A1A] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">深邃夜空</p>
                            </div>
                            
                            <!-- 薄荷清新 -->
                            <div class="template-option" data-template="mint"
                                data-bg-color="#E8F5E9" data-text-color="#2C3E50" data-name="薄荷清新" data-custom="false">
                                <div class="h-16 bg-[#E8F5E9] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">薄荷清新</p>
                            </div>
                            
                            <!-- 天空蓝 -->
                            <div class="template-option" data-template="sky"
                                data-bg-color="#E3F2FD" data-text-color="#2C3E50" data-name="天空蓝" data-custom="false">
                                <div class="h-16 bg-[#E3F2FD] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">天空蓝</p>
                            </div>
                            
                            <!-- 暖阳橙 -->
                            <div class="template-option" data-template="sunset"
                                data-bg-color="#FFF3E0" data-text-color="#2C3E50" data-name="暖阳橙" data-custom="false">
                                <div class="h-16 bg-[#FFF3E0] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">暖阳橙</p>
                            </div>
                            
                            <!-- 浅粉红 -->
                            <div class="template-option" data-template="pink"
                                data-bg-color="#FCE4EC" data-text-color="#2C3E50" data-name="浅粉红" data-custom="false">
                                <div class="h-16 bg-[#FCE4EC] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">浅粉红</p>
                            </div>
                            
                            <!-- 淡紫色 -->
                            <div class="template-option" data-template="lavender"
                                data-bg-color="#F3E5F5" data-text-color="#2C3E50" data-name="淡紫色" data-custom="false">
                                <div class="h-16 bg-[#F3E5F5] rounded-lg shadow-sm"></div>
                                <p class="mt-2 text-xs text-center text-gray-600">淡紫色</p>
                            </div>
                        </div>
                    </div>

                    <!-- 自定义背景颜色 -->
                    <div class="mt-4">
                        <label class="input-label">自定义背景颜色</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="bg-color" value="#FFFFFF" class="w-full h-10 rounded-lg cursor-pointer">
                            <div class="bg-white px-3 py-2 rounded-lg border border-gray-200 min-w-[90px] text-sm text-gray-600" id="color-value">
                                #FFFFFF
                            </div>
                        </div>
                    </div>

                    <!-- 底座颜色 -->
                    <div>
                        <h3 class="input-label">底座颜色</h3>
                        <div class="flex flex-wrap gap-2">
                            <div class="gradient-option selected" data-gradient="none" style="background: #e5e7eb;">
                                <span class="text-red-500 text-2xl flex items-center justify-center h-full">🚫</span>
                            </div>
                            <div class="gradient-option base-color-1" data-gradient="base-color-1"></div>
                            <div class="gradient-option base-color-2" data-gradient="base-color-2"></div>
                            <div class="gradient-option base-color-3" data-gradient="base-color-3"></div>
                            <div class="gradient-option base-color-4" data-gradient="base-color-4"></div>
                            <div class="gradient-option base-color-5" data-gradient="base-color-5"></div>
                            <div class="gradient-option base-color-6" data-gradient="base-color-6"></div>
                            <div class="gradient-option base-color-7" data-gradient="base-color-7"></div>
                            <div class="gradient-option base-color-8" data-gradient="base-color-8"></div>
                            <div class="gradient-option base-color-9" data-gradient="base-color-9"></div>
                        </div>
                    </div>

                    <!-- 字体设置 -->
                    <div>
                        <label class="input-label">字体选择</label>
                        <select id="font-family" class="w-full border border-gray-300 rounded-lg p-2">
                            <!-- 无衬线字体 -->
                            <optgroup label="无衬线字体">
                                <option value="system-ui, -apple-system">系统默认</option>
                                <option value="'PingFang SC', 'Microsoft YaHei'">苹方 / 微软雅黑</option>
                                <option value="'Noto Sans SC'">思源黑体</option>
                                <option value="'Helvetica Neue', Arial">Helvetica</option>
                            </optgroup>
                            <!-- 衬线字体 -->
                            <optgroup label="衬线字体">
                                <option value="'SimSun', serif">宋体</option>
                                <option value="'SimKai', serif">楷体</option>
                                <option value="'SimHei', sans-serif">黑体</option>
                                <option value="'FangSong', serif">仿宋</option>
                            </optgroup>
                            <!-- 特殊字体 -->
                            <optgroup label="特殊字体">
                                <option value="'LXGW WenKai'">霞鹜文楷</option>
                                <option value="'Zhi Mang Xing'">智慧体</option>
                                <option value="'Ma Shan Zheng'">马善政体</option>
                            </optgroup>
                        </select>
                    </div>

                    <div>
                        <label class="input-label">字体大小</label>
                        <input type="number" id="font-size" value="16" min="12" max="72" 
                            class="w-full border border-gray-300 rounded-lg p-2">
                    </div>

                    <!-- 其他设置 -->
                    <div>
                        <label class="input-label">图片比例</label>
                        <select id="aspect-ratio" class="w-full border border-gray-300 rounded-lg p-2">
                            <option value="auto">自由比例</option>
                            <option value="1:1">1:1 正方形</option>
                            <option value="4:3">4:3 横版</option>
                            <option value="16:9">16:9 宽屏</option>
                            <option value="3:4">3:4 竖版</option>
                            <option value="9:16">9:16 手机屏</option>
                        </select>
                    </div>

                    <div>
                        <label class="input-label">自动分割长文本</label>
                        <div class="flex items-center">
                            <input type="checkbox" id="auto-split" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-600">自动将长文本分割成多张卡片</span>
                        </div>
                    </div>

                    <!-- 在样式设置区域添加卡片大小设置 -->
                    <div>
                        <label class="input-label">卡片大小</label>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="custom-size" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-600">自定义大小</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2" id="size-inputs">
                                <div>
                                    <label class="text-xs text-gray-500">宽度 (px)</label>
                                    <input type="number" id="card-width" value="800" min="200" max="2000" 
                                        class="w-full border border-gray-300 rounded-lg p-2 disabled:bg-gray-100 disabled:text-gray-500" disabled>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">高度 (px)</label>
                                    <input type="number" id="card-height" value="400" min="200" max="2000"
                                        class="w-full border border-gray-300 rounded-lg p-2 disabled:bg-gray-100 disabled:text-gray-500" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 下部分：预览和导出区域 -->
        <div class="space-y-6">
            <!-- 预览区域 -->
            <div class="control-panel">
                <h2 class="section-title text-center">预览</h2>
                <div class="preview-container">
                    <div id="card-preview" class="card-preview"></div>
                </div>
            </div>

            <!-- 导出按钮区域 -->
            <div class="flex justify-center space-x-4 mt-6">
                <button id="download-png" 
                    data-format="png"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center">
                    <span class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        导出为PNG
                    </span>
                </button>
                <button id="download-jpg"
                    data-format="jpg"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center">
                    <span class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        导出为JPG
                    </span>
                </button>
            </div>
            
            <!-- 导出提示 -->
            <div class="text-center mt-4 text-sm text-gray-500">
                <p>提示：导出的图片将保持原始比例和质量</p>
            </div>
        </div>
    </div>
</div>

<script>
// 初始化预览
function initPreview() {
    const preview = document.getElementById('card-preview');
    preview.style.minHeight = window.innerWidth > 1024 ? '400px' : '250px';
    updatePreview();
}

// 设置按钮加载状态
function setButtonLoading(button, loading) {
    if (!button) return;
    
    const format = button.getAttribute('data-format');
    const originalText = `导出为${format.toUpperCase()}`;
    
    button.disabled = loading;
    button.innerHTML = loading ? 
        `<span class="loading"></span> 导出中...` : 
        `<span class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            ${originalText}
        </span>`;
}

// 显示提示信息
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    const bgColor = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
    }[type] || 'bg-blue-500';
    
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${bgColor} text-white`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// 导出图片
async function exportToImage(format) {
    const preview = document.getElementById('card-preview');
    const button = document.getElementById(`download-${format}`);
    
    try {
        setButtonLoading(button, true);
        
        // 获取卡片实际内容区域的尺寸和样式
        const cardStyle = window.getComputedStyle(preview);
        const width = preview.offsetWidth;
        const height = preview.offsetHeight;
        
        // 创建临时容器，只包含卡片内容
        const tempWrapper = document.createElement('div');
        tempWrapper.style.cssText = `
            position: fixed;
            left: -9999px;
            top: -9999px;
            width: ${width}px;
            height: ${height}px;
            background-color: ${format === 'jpg' ? '#ffffff' : 'transparent'};
            overflow: hidden;
            border-radius: ${cardStyle.borderRadius};
        `;
        document.body.appendChild(tempWrapper);
        
        // 克隆预览内容（包含水印）
        const clonedContent = preview.cloneNode(true);
        
        // 复制所有计算后的样式
        const computedStyle = window.getComputedStyle(preview);
        Array.from(computedStyle).forEach(key => {
            clonedContent.style[key] = computedStyle[key];
        });
        
        // 确保尺寸和位置正确
        clonedContent.style.cssText += `
            width: ${width}px;
            height: ${height}px;
            margin: 0;
            position: relative;
            transform: none;
            border-radius: ${cardStyle.borderRadius};
            background: ${cardStyle.background};
        `;
        
        // 将克隆的内容添加到临时容器
        tempWrapper.appendChild(clonedContent);
        
        // 配置html2canvas
        const canvas = await html2canvas(tempWrapper, {
            scale: 1, // 保持原始尺寸
            useCORS: true, // 支持跨域图片
            backgroundColor: format === 'jpg' ? '#ffffff' : null,
            logging: false,
            allowTaint: true,
            width: width,
            height: height,
            imageTimeout: 0,
            removeContainer: true,
            onclone: function(clonedDoc) {
                // 确保渐变和样式正确应用
                const clonedElement = clonedDoc.querySelector('#card-preview');
                if (clonedElement) {
                    clonedElement.style.cssText = clonedContent.style.cssText;
                }
            }
        });
        
        // 清理临时容器
        document.body.removeChild(tempWrapper);
        
        // 转换为blob并下载
        canvas.toBlob(function(blob) {
            if (!blob) {
                throw new Error('生成图片失败');
            }
            
            const timestamp = new Date().getTime();
            const filename = `text-card-${width}x${height}-${timestamp}.${format}`;
            
            saveAs(blob, filename);
            showToast('导出成功！', 'success');
        }, format === 'png' ? 'image/png' : 'image/jpeg', format === 'jpg' ? 0.92 : undefined);
        
    } catch (error) {
        console.error('导出图片失败:', error);
        showToast(`导出失败: ${error.message}`, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

// 自动分割长文本
function splitLongText(text) {
    if (!document.getElementById('auto-split').checked) return [text];
    
    const maxLength = 500; // 每张卡片的最大字符数
    const paragraphs = text.split('\n\n');
    const cards = [];
    let currentCard = '';
    
    for (const paragraph of paragraphs) {
        if (currentCard.length + paragraph.length > maxLength) {
            if (currentCard) cards.push(currentCard.trim());
            currentCard = paragraph;
        } else {
            currentCard += (currentCard ? '\n\n' : '') + paragraph;
        }
    }
    
    if (currentCard) cards.push(currentCard.trim());
    return cards;
}

// 示例文本
const examples = {
    example1: `# 心灵鸡汤

> 生活不是等待暴风雨过去，而是学会在雨中翩翩起舞。

**每一个不曾起舞的日子，都是对生命的辜负。**`,

    example2: `# 工作笔记

## 今日任务

- [x] 完成项目方案
- [x] 团队会议
- [ ] 代码审查

*deadline: 2024-03-20*`,

    example3: `# 美食食谱

## 红烧肉

1. 准备食材
2. 煸炒糖色
3. 加入调料

*Tips: 小火慢炖更入味*`
};

// 加载示例文本
function loadExample(id) {
    const textarea = document.getElementById('text-input');
    textarea.value = examples[`example${id}`];
    updatePreview();
}

// 更新预览
function updatePreview() {
    const preview = document.getElementById('card-preview');
    const previewContainer = document.querySelector('.preview-container');
    const selectedTemplate = document.querySelector('.template-option.selected');
    const isCustomTemplate = selectedTemplate.dataset.custom === 'true';
    const bgColorInput = document.getElementById('bg-color');
    const customSizeCheckbox = document.getElementById('custom-size');
    const width = parseInt(document.getElementById('card-width').value);
    const height = parseInt(document.getElementById('card-height').value);
    const fontFamily = document.getElementById('font-family').value;
    const fontSize = document.getElementById('font-size').value;
    
    // 重置预览区域
    preview.innerHTML = '';
    preview.className = 'card-preview';
    
    // 创建并添加字体样式
    const fontStyle = document.createElement('style');
    fontStyle.setAttribute('data-type', 'custom-font');
    fontStyle.textContent = `
        .card-content {
            font-family: ${fontFamily} !important;
            font-size: ${fontSize}px !important;
            letter-spacing: 0.025em;
            text-rendering: optimizeLegibility;
        }
        .card-content * {
            font-family: inherit !important;
            letter-spacing: inherit;
        }
        /* 标题特殊处理 */
        .card-content h1,
        .card-content h2,
        .card-content h3,
        .card-content h4,
        .card-content h5,
        .card-content h6 {
            font-weight: 700;
            line-height: 1.4;
        }
    `;
    document.head.appendChild(fontStyle);
    
    // 添加底座颜色（最底层）
    const baseColor = document.querySelector('.gradient-option.selected').dataset.gradient;
    if (baseColor !== 'none') {
        const baseColorElement = document.createElement('div');
        baseColorElement.className = `base-color ${baseColor}`;
        preview.appendChild(baseColorElement);
    }
    
    // 创建内容包装器（中间层）
    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'content-wrapper';
    preview.appendChild(contentWrapper);
    
    // 创建内容容器（背景层）
    const contentContainer = document.createElement('div');
    contentContainer.className = 'bg-template';
    contentContainer.style.cssText = `
        padding-bottom: 40px; /* 增加底部内边距，为水印留出空间 */
    `;
    contentWrapper.appendChild(contentContainer);
    
    // 创建水印容器（最上层，但在内容容器内）
    const watermarkContainer = document.createElement('div');
    watermarkContainer.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
    `;
    contentContainer.appendChild(watermarkContainer);
    
    // 添加时间水印
    const dateWatermark = document.createElement('div');
    const now = new Date();
    const dateStr = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`;
    dateWatermark.style.cssText = `
        position: absolute;
        top: 12px;
        left: 12px;
        font-size: 12px;
        color: rgba(0, 0, 0, 0.3);
        z-index: 20;
    `;
    dateWatermark.textContent = dateStr;
    watermarkContainer.appendChild(dateWatermark);
    
    // 添加版权水印
    const copyrightWatermark = document.createElement('div');
    copyrightWatermark.style.cssText = `
        position: absolute;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        color: rgba(0, 0, 0, 0.3);
        z-index: 20;
    `;
    copyrightWatermark.textContent = '@Generate By MEDIAS.AI';
    watermarkContainer.appendChild(copyrightWatermark);
    
    // 添加字数统计水印
    const textContent = document.getElementById('text-input').value;
    const wordCount = textContent.replace(/\s/g, '').length;
    const wordCountWatermark = document.createElement('div');
    wordCountWatermark.style.cssText = `
        position: absolute;
        bottom: 16px;
        right: 12px;
        font-size: 12px;
        color: rgba(0, 0, 0, 0.3);
        z-index: 20;
    `;
    wordCountWatermark.textContent = `字数：${wordCount}`;
    watermarkContainer.appendChild(wordCountWatermark);

    // 设置预览尺寸
    if (customSizeCheckbox.checked && !isNaN(width) && !isNaN(height)) {
        preview.style.width = `${width}px`;
        preview.style.height = `${height}px`;
        preview.style.minHeight = `${height}px`;
        previewContainer.style.minWidth = `${width + 80}px`;
        previewContainer.style.minHeight = `${height + 80}px`;
    }

    // 添加实际内容
    const text = document.getElementById('text-input').value;
    const cards = splitLongText(text);

    cards.forEach((cardText, index) => {
        if (index > 0) {
            const pageDivider = document.createElement('div');
            pageDivider.className = 'border-t border-gray-200 my-4';
            contentContainer.appendChild(pageDivider);
        }

        const cardElement = document.createElement('div');
        cardElement.className = 'card-content markdown-body custom-font';
        cardElement.innerHTML = marked.parse(cardText);
        cardElement.style.cssText = `
            font-family: ${fontFamily} !important;
            font-size: ${fontSize}px;
        `;
        contentContainer.appendChild(cardElement);
    });

    // 设置背景颜色和文字颜色
    if (isCustomTemplate) {
        preview.style.setProperty('--bg-color', bgColorInput.value);
    } else {
        preview.style.setProperty('--bg-color', selectedTemplate.dataset.bgColor);
        bgColorInput.value = selectedTemplate.dataset.bgColor;
    }
    
    // 设置文字颜色（对所有模板都生效）
    document.documentElement.style.setProperty('--text-color', selectedTemplate.dataset.textColor);
    
    // 将内容容器添加到包装器
    contentWrapper.appendChild(contentContainer);

    // 应用比例设置
    const ratio = document.getElementById('aspect-ratio').value;
    if (ratio !== 'auto') {
        const baseWidth = 800;
        const [width, height] = ratio.split(':').map(Number);
        const calculatedHeight = Math.round((baseWidth * height) / width);
        
        preview.style.width = `${baseWidth}px`;
        preview.style.height = `${calculatedHeight}px`;
        
        // 更新预览容器尺寸
        previewContainer.style.minWidth = `${baseWidth + 80}px`;
        previewContainer.style.minHeight = `${calculatedHeight + 80}px`;
    }

    // 将包装器添加到预览区域
    preview.appendChild(contentWrapper);

    // 清理之前的字体样式
    return () => {
        if (document.head.contains(fontStyle)) {
            document.head.removeChild(fontStyle);
        }
    };
}

// 模板选择事件处理
document.querySelectorAll('.template-option').forEach(option => {
    option.addEventListener('click', function() {
        // 移除其他模板的选中状态
        document.querySelectorAll('.template-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // 添加当前模板的选中状态
        this.classList.add('selected');
        
        // 获取模板数据
        const bgColor = this.dataset.bgColor;
        const textColor = this.dataset.textColor;
        const isCustom = this.dataset.custom === 'true';
        
        // 更新背景色输入框和预览
        const bgColorInput = document.getElementById('bg-color');
        bgColorInput.value = bgColor;
        bgColorInput.disabled = !isCustom;
        
        // 更新颜色值显示
        const colorValueDisplay = document.getElementById('color-value');
        colorValueDisplay.textContent = bgColor.toUpperCase();
        
        // 更新CSS变量
        const preview = document.getElementById('card-preview');
        preview.style.setProperty('--bg-color', bgColor);
        document.documentElement.style.setProperty('--text-color', textColor);
        
        updatePreview();
    });
});

// 监听渐变选择
document.querySelectorAll('.gradient-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.gradient-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        this.classList.add('selected');
        updatePreview();
    });
});

// 监听其他设置变化
// 字体选择实时更新
document.getElementById('font-family').addEventListener('change', function() {
    // 清除之前的字体样式
    const oldFontStyles = document.querySelectorAll('style[data-type="custom-font"]');
    oldFontStyles.forEach(style => style.remove());
    
    updatePreview();
});

// 字体大小实时更新
const fontSizeInput = document.getElementById('font-size');
fontSizeInput.addEventListener('input', updatePreview);
fontSizeInput.addEventListener('change', updatePreview);

// 背景颜色变化时的处理
const bgColorInput = document.getElementById('bg-color');
const colorValueDisplay = document.getElementById('color-value');

bgColorInput.addEventListener('input', function() {
    // 当背景颜色改变时，自动切换到自定义模板
    const customTemplate = document.querySelector('.template-option[data-template="clean"]');
    if (!customTemplate.classList.contains('selected')) {
        document.querySelectorAll('.template-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        customTemplate.classList.add('selected');
    }
    
    // 直接更新CSS变量
    const preview = document.getElementById('card-preview');
    preview.style.setProperty('--bg-color', this.value);
    document.documentElement.style.setProperty('--text-color', customTemplate.dataset.textColor);
    
    // 更新颜色值显示
    colorValueDisplay.textContent = this.value.toUpperCase();
    
    updatePreview();
});

// 修改图片比例变化的事件处理
document.getElementById('aspect-ratio').addEventListener('change', function() {
    const preview = document.getElementById('card-preview');
    const ratio = this.value;
    const customSizeCheckbox = document.getElementById('custom-size');
    const cardWidth = document.getElementById('card-width');
    const cardHeight = document.getElementById('card-height');
    const previewContainer = document.querySelector('.preview-container');
    
    // 获取预览区域的基准宽度
    const baseWidth = 800;
    
    if (ratio === 'auto') {
        preview.style.aspectRatio = 'auto';
        preview.style.width = '';
        preview.style.height = '';
        previewContainer.style.minWidth = '';
        previewContainer.style.minHeight = '300px';
        
        // 允许自定义大小
        customSizeCheckbox.disabled = false;
        customSizeCheckbox.parentElement.classList.remove('opacity-50');
    } else {
        const [width, height] = ratio.split(':').map(Number);
        // 计算对应的高度
        const calculatedHeight = Math.round((baseWidth * height) / width);
        
        // 立即应用尺寸
        preview.style.width = `${baseWidth}px`;
        preview.style.height = `${calculatedHeight}px`;
        preview.style.aspectRatio = `${width}/${height}`;
        
        // 立即更新预览容器尺寸
        previewContainer.style.minWidth = `${baseWidth + 80}px`;
        previewContainer.style.minHeight = `${calculatedHeight + 80}px`;
        
        // 立即更新尺寸输入框的值
        cardWidth.value = baseWidth;
        cardHeight.value = calculatedHeight;
        
        // 禁用自定义大小
        customSizeCheckbox.checked = false;
        customSizeCheckbox.disabled = true;
        customSizeCheckbox.parentElement.classList.add('opacity-50');
        // 禁用尺寸输入
        cardWidth.disabled = true;
        cardHeight.disabled = true;
    }
    
    // 立即更新预览
    updatePreview();
    
    // 确保比例应用后的内容布局正确
    setTimeout(() => {
        updatePreview();
    }, 100);
});

// 监听自动分割开关
document.getElementById('auto-split').addEventListener('change', updatePreview);

// 绑定导出按钮事件
document.getElementById('download-png').addEventListener('click', () => exportToImage('png'));
document.getElementById('download-jpg').addEventListener('click', () => exportToImage('jpg'));

// 绑定示例按钮事件
document.getElementById('example-1').addEventListener('click', () => loadExample(1));
document.getElementById('example-2').addEventListener('click', () => loadExample(2));
document.getElementById('example-3').addEventListener('click', () => loadExample(3));

// 初始化预览
updatePreview();

// 初始化时设置颜色值显示
document.addEventListener('DOMContentLoaded', function() {
    colorValueDisplay.textContent = bgColorInput.value.toUpperCase();
});

// 监听文本输入，自动调整卡片大小
const textInput = document.getElementById('text-input');
textInput.addEventListener('input', function() {
    if (!customSizeCheckbox.checked) {
        // 只在非自定义大小模式下自动调整
        const preview = document.getElementById('card-preview');
        preview.style.width = '';
        preview.style.height = '';
    }
    updatePreview();
});

// 自定义大小相关的事件处理
const customSizeCheckbox = document.getElementById('custom-size');
const sizeInputs = document.getElementById('size-inputs');
const cardWidth = document.getElementById('card-width');
const cardHeight = document.getElementById('card-height');

// 监听自定义大小开关
customSizeCheckbox.addEventListener('change', function() {
    // 检查是否为自由比例
    const aspectRatio = document.getElementById('aspect-ratio').value;
    if (aspectRatio !== 'auto') {
        this.checked = false;
        return;
    }
    
    cardWidth.disabled = !this.checked;
    cardHeight.disabled = !this.checked;
    
    if (!this.checked) {
        const preview = document.getElementById('card-preview');
        preview.style.width = '';
        preview.style.height = '';
        
        // 重置预览容器尺寸
        const previewContainer = document.querySelector('.preview-container');
        previewContainer.style.minWidth = '';
        previewContainer.style.minHeight = '300px';
    } else {
        // 切换到自定义模式时，使用当前实际尺寸作为初始值
        const actualWidth = Math.round(preview.offsetWidth);
        const actualHeight = Math.round(preview.offsetHeight);
        cardWidth.value = actualWidth;
        cardHeight.value = actualHeight;
        
        // 立即应用这些尺寸
        preview.style.width = `${actualWidth}px`;
        preview.style.height = `${actualHeight}px`;
        previewContainer.style.minWidth = `${actualWidth + 80}px`;
        previewContainer.style.minHeight = `${actualHeight + 80}px`;
    }
    
    updatePreview();
});

// 监听宽度输入
cardWidth.addEventListener('input', function() {
    if (!customSizeCheckbox.checked) return;
    
    const width = parseInt(this.value);
    if (isNaN(width) || width < 200 || width > 2000) return;
    
    const preview = document.getElementById('card-preview');
    const previewContainer = document.querySelector('.preview-container');
    
    // 应用新宽度
    preview.style.width = `${width}px`;
    previewContainer.style.minWidth = `${width + 80}px`;
    
    // 触发一次完整的预览更新
    updatePreview();
});

// 监听高度输入
cardHeight.addEventListener('input', function() {
    if (!customSizeCheckbox.checked) return;
    
    const height = parseInt(this.value);
    if (isNaN(height) || height < 200 || height > 2000) return;
    
    const preview = document.getElementById('card-preview');
    const previewContainer = document.querySelector('.preview-container');
    
    // 应用新高度
    preview.style.height = `${height}px`;
    previewContainer.style.minHeight = `${height + 80}px`;
    
    // 触发一次完整的预览更新
    updatePreview();
});

// 在页面加载时初始化状态
document.addEventListener('DOMContentLoaded', function() {
    // ... 其他初始化代码 ...
    
    // 初始化图片比例和自定义大小的联动状态
    const aspectRatio = document.getElementById('aspect-ratio').value;
    const customSizeCheckbox = document.getElementById('custom-size');
    
    if (aspectRatio !== 'auto') {
        customSizeCheckbox.checked = false;
        customSizeCheckbox.disabled = true;
        customSizeCheckbox.parentElement.classList.add('opacity-50');
    }

    // 添加字体加载检测
    checkFontLoading();
});

// 添加loading样式
const style = document.createElement('style');
style.textContent = `
.loading {
    display: inline-block;
    width: 1em;
    height: 1em;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
    margin-right: 0.5em;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
`;
document.head.appendChild(style);

// 添加字体加载检测
function checkFontLoading() {
    const fontFamilies = [
        'Noto Sans SC',
        'LXGW WenKai',
        'Zhi Mang Xing',
        'Ma Shan Zheng'
    ];

    Promise.all(fontFamilies.map(font => document.fonts.load(`1em "${font}"`)))
        .then(() => {
            console.log('所有字体加载完成');
            updatePreview();
        })
        .catch(err => {
            console.warn('部分字体加载失败:', err);
            updatePreview();
        });
}
</script>
{% endblock %} 